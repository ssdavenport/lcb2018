---
title: "Traceability-Based Findings v 1.1"
author: "Steven Davenport"
date: "`r format(Sys.time(), '%B %d, %Y (%H:%M)')`"
output: html_document
---

v1.1 (June 29) incorporated comments from Kee Won.
v1.0 (June 27) provided outline and early tables.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
```

```{r, echo=FALSE}
make_date <- function(yyyy, m, quarter=F) {
  # we need this for negative substring indexing
  require(stringr)
  # year is 4 digits; month is either 1 or 2 digits.
  # Correct month by prefixing 0, getting all but last digit
  month <- str_sub(paste0(0, m), -2) 
  
  as.Date(paste0(yyyy, "-", month, "-01"))
}
```

## Outline

This document will consolidate findings related to the WA traceability data. We have been tasked to pull the following parameters/insights:

+ Producer-Level (i.e. Farm-Gate / Primary Products)
  + Raw Production (Harvest, Flower (dry/wet) and Other Plant Material)
    + Gross weight
    + Revenues **?**
    + THC Content
  + Harvest-Stage Waste/Discards
  + *NOTE: does Usable Marijuana go here or below?*
+ Processor-Level (Post-Harvest)
  + Secondary Production (e.g. BHO, ...)
    + Gross weight
    + Unit counts
    + Revenues
  + Waste/Discards (Processing/Inventory stage)
    + *NOTE: What are processes here?*
  + Conversion Ratios (grams-to-grams / grams-to-units)
    + Flower to concentrate (intermediate or final products)
    + Other Plant Material to concentrate (intermediate or final products)
+ Retail-Level
  + Sales volume by retail product type (Units, $):
    + Usable Marijuana; Marijuana Mix Infused; Marijuna Mix Package; etc.
  + THC Content and trends
    + Usable Marijuana; Marijuana Mix Infused; Marijuna Mix Package; etc.
+ Licensee-level (be careful conflating license type w services provided)
  + Producer/Producer-Processor Revenues
  + Processor Revenues (not in proj desc)
  + Store Revenues

## Methodology

### Production

```{r}
# Queries
# Filters out deleted plants and plants that are duplicated
# Create the table: plant_derivatives_distinct
# select plantid, sessiontime, inventorytype, location, MAX(dweight) AS dweight
# from (
# SELECT *
# FROM [rand-systems:full_WA_data__proper.biotrackthc_plantderivatives]
# WHERE deleted = 0)
# group by plantid, sessiontime, inventorytype, location;
# 
# #This combines all of the weights for the same plant (where there were multiple harvests), creates table: plant_stats_distinct
# select location, plantid, MIN(sessiontime) AS sessiontime,
# SUM(CASE WHEN inventorytype = 29 THEN dweight else 0 END) as wet_weight,
# SUM(CASE WHEN inventorytype = 6 THEN dweight else 0 END) as dry_weight,
# SUM(CASE WHEN inventorytype = 9 THEN dweight else 0 END) as opm_weight
# from [rand-systems:TEAM_WORKSPACE_USE_ME.plant_derivatives_distinct]
# group by location, plantid;

# RUN THIS QUERY

#This query is saved in the table: plant_stats_distinct_location
# select a.location AS location, b.locationtype AS locationtype, a.plantid AS plantid,
# a.sessiontime AS sessiontime, a.wet_weight AS wet_weight, a.dry_weight AS dry_weight,
# a.opm_weight AS opm_weight
# from [rand-systems:TEAM_WORKSPACE_USE_ME.plant_stats_distinct] a
# JOIN (
# select id, locationtype
# FROM
# [rand-systems:full_WA_data__proper.biotrackthc_locations]) b ON a.location =b.id
# WHERE b.locationtype < 7;
```
#### Gross weight

Most tables can be joined by "location". KW can provide if given a time frame. Can share code.

#### THC content is harder.  

table: plantderivatives. Almost all dry flower has inventoryid. Many plants have a wet weight but no dry weight, e.g. 250,000 plants in November 2017 due to end of traceability reporting.

Join: plantderivatives::inventoryid - inventoryid::labresults_samples. Might not work. TODO: Diagnose.

### Revenue

inventorytransfer::saleprice. 
Validate/verify this. (5.3mil records)



### Waste/Discards

table: "inventoryderivatives". Waste from harvesting.
table: plantderivatives. (what stage is this?)
Requires substantial data cleaning. Simple sums give crazy numbers.

Maybe also more post-harvest waste in other inventorytables.
inventory::waste record count: 989,387 
sum(inventory::waste[inventorytype==26]) > 600mil kg (assuming units = gram)

```{r}

```

### Processor-Level

88.5% of dry weight (2016) came from producer/processors.
Secondary (non-flower) product types are mysterious. LCB should advise.
KW tried conversions, combinations, transfers

#### Conversion ratios

table: inventoryconversions.
see KW matrix: beginning -> end product type.

#### Waste/Discards (Processing/Inventory stage)

Check other inventory tables.


#### Production volumes

## Results

### Raw Production
#### Volume: Weight, Revenues
#### Volume: kg THC?
#### THC Content (%)
#### Harvest-Stage Waste/Discards

### Secondary Processing
#### Volume: Weight, Units, Revenues
#### Waste/Discards (Processing/Inventory stage)
#### Conversion Ratios (grams-to-grams / grams-to-units)
##### Flower to concentrate (intermediate or final products)
##### Other Plant Material to concentrate (intermediate or final products)

### Retail Products

```{r, retailVolume}
# GoogleQuery: RetailUSDxType
retailUSDxType <- read_csv("../gqoutput/results-20180627-174927.csv") %>%
  mutate(date=make_date(YEAR, MONTH)) %>%
  # Convert to $1000s
  mutate(price_x = price_x / 1e3) %>%
  filter(
    # remove NA
    !is.na(invtype),
    # remove non-retail products in here for no reason
    !invtype%in%c("Clone", "Mature Plant"),
    # Remove the partial month of October 2017
    date <= "2017-10-01")
```

#### Volume: Units, $ (x product type)

##### Sales Volume (Units)

```{r, echo=FALSE}
# TODO: Update query for proper unit/item-transaction definition
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=itemtransactions, color=invtype)) + geom_line() +
  labs(title="Retail Item-Transactions by Inventory Type",
       y="Item-transactions (retail data rows)",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")


# Table
retailUSDxType %>%
  select(invtype, date, itemtransactions) %>%
  spread(invtype, itemtransactions) %>%
  knitr::kable(caption='Retail Item-Transactions By Inventory Type', digits=0)

```

##### Sales Volume (Dollars)

```{r, echo=FALSE}
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=price_x, color=invtype)) + geom_line() +
  labs(title="Gross Retail Sales by Inventory Type",
       y="$1000, Post-Excise",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months") +
  scale_y_continuous(labels=scales::dollar_format())


# Table
retailUSDxType %>%
  select(invtype, date, price_x) %>%
  spread(invtype, price_x) %>%
  knitr::kable(caption='Post-Excise Tax Sales By Inventory Type ($1k)', digits=0)

```


#### THC Content

TODO: Modify query to clean THC data (some are >100)

```{r, echo=FALSE}
# TODO: Update query for weighted averages
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=totalTHC, color=invtype)) + geom_line() +
  labs(title="THC Content by Inventory Type",
       y="THC Percent",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")


# Table
retailUSDxType %>%
  select(invtype, date, totalTHC) %>%
  spread(invtype, totalTHC) %>%
  knitr::kable(caption='Mean THC Content By Inventory Type', digits=0)

```

#### CBD Content

```{r, echo=FALSE}
# TODO: Update query for weighted averages
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=totalCBD, color=invtype)) + geom_line() +
  labs(title="CBD Content by Inventory Type",
       y="CBD Percent",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")


# Table
retailUSDxType %>%
  select(invtype, date, totalCBD) %>%
  spread(invtype, totalCBD) %>%
  knitr::kable(caption='Mean CBD Content By Inventory Type', digits=0)

```

### Licensee Revenue Analysis
(be careful conflating license type w services provided)

#### Producer/Producer-Processor Revenues


```{r}
# GoogleQuery: ?????

# Aggregate revenues for all producers.

```

#### Processor Revenues (not in proj desc)
#### Store Revenues
