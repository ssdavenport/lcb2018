---
title: "Chapter 4 - Traceability-Based Supply Estimates"
author: "Steven Davenport"
date: "`r format(Sys.time(), '%B %d, %Y (%H:%M)')`"
output:
  word_document:
    toc: yes
    toc_depth: '3'
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.align='center')
source("chap4code.r")
```

## 4.0 Summary

## 4.1 Introduction

(Briefly describe how the traceability system records events, which events, and about supply chain pathways)


## 4.2 THC and CBD Concentrations and Volumes

All marijuana products sold in Washington State are required to be tested for potency and purity. It is not true that literally every product it tested, but every product must descend from a larger unit (e.g. a lot) from which a small sample was taken to a lab for testing, and the results of that test are extrapolated to represent the population from which it was sampled. Although marijuana contains over 113 cannabinoids with potentially psychoactive properties, THC (tetrahydrocannabinol) and CBD (cannabidiol) are the principal psychoactive components, required to be reported in potency tests. THC and CBD levels presented here represent amounts of "Total THC" or "Total CBD", as calculated under Washington State regulations (Total THC = THC + 0.877*THCA), representing estimated molecular weight post-decarboxylation [1].


Testing occurs at various points in the supply chain, depending on the intended retail product type. It is common to test marijuana at the "Flower Lot" stage, after material has been harvested from the marijuana plant and grouped into generally 5 or 10 pound lots. The THC/CBD concentrations for all product sold as "usable marijuana" derive from tests of flower lot. It is also common to test intermediate products after they have been manufactured, as the manufactured product will have different THC/CBD concentrations than the plant material from which it was produced and also potentially may include dangerous residual chemicals from the manufacturing process. These tests are responsible for the THC/CBD concentrations of products sold as "marijuana extracts for inhalation" or "tinctures". Finally, products sold as capsules, suppositories, or marijuana infused edibles are further required to undergo testing at that stage, after the intermediate product has been produced into the final retail product.

The tables and charts below show the changing THC and CBD concentrations of marijuana products over time. Below we compute the simple average of THC/CBD concentrations among tested products.  Note: CBD was not tracked well in 2014/2015.


^[1] In raw cannabis, e.g. on the flowering plant, these chemicals largely remain carboxylated and are said to exist in the acid form, and therefore are denoted as THC-A (THC-"acid") or CBD-A. In order for these chemicals to yield psychoactive effects they must first be decarboxylated, a process in which the acid component is removed (i.e., THC-A is converted to THCA). When decarboxylation occurs depends on the method of consumption. The dried flower form of marijuana is largely carboxylated, and is not decarboxylated until the user applies a source of heat e.g. a lighter or vaporizer to consume the material. This case also holds for many forms of marijuana extracts, with the exception of products such as tinctures intended for oral application, which are decarboxylated prior to use. In the consumption of marijuana edibles, decarboxylation is largely occurs in the user's digestive tract. 

### THC Concentrations


Ingredients.

```{r}
# ingredients
potencyAnnual %>% 
  select(-TotalCBD, -inventorytype) %>%
  filter(invtype %in% c(lots, ingrdnts)) %>%
  ungroup %>%
  mutate(invtype = reorder(invtype, -(TotalTHC))) %>%
  spread(year, TotalTHC) %>%
  kable(digits=1, caption='Ingredient Average THC Concentrations, by Year', align="lcccccccccc")

potencyMonthly %>% 
  filter(!invtype%in%c(retailOther, retailFlower)) %>%
  mutate(invtype = reorder(invtype, -(TotalTHCs))) %>%
  ggplot(aes(x=date, y=TotalTHCs, color=invtype)) + geom_point() + geom_line() + theme_minimal() +
  labs(title="Ingredient Products", y='THC%', color="Ingredient") 
```

Retail.

```{r}
# Retail
potencyAnnual %>% 
  select(-TotalCBD, -inventorytype) %>%
  filter(invtype%in%c(retailOther, retailFlower)) %>%
  ungroup %>%
  mutate(invtype = reorder(invtype, -(TotalTHC))) %>%
  spread(year, TotalTHC) %>%
  kable(digits=1, caption='Ingredient Average THC Concentrations, by Year', align="lcccccccccc")


potencyMonthly %>% 
  filter(invtype%in%c(retailOther, retailFlower)) %>%
    mutate(invtype = reorder(invtype, -(TotalTHCs))) %>%
  ggplot(aes(x=date, y=TotalTHCs, color=invtype)) + geom_point() + geom_line() +theme_minimal() +
  labs(title="Retail Products", y='THC%', color="Retail Product")
```

### CBD Concentrations

Note: usableweight content for solid/liquid edibles is clearly wrong/too small. **To do: add estimated content for edibles to this table.** Also note that "usable marijuana" comes from flower lots, so potency for that should be equal to flower lots.


```{r}

# Display CBD
potencyAnnual %>% 
  select(-TotalTHC, -inventorytype) %>%
  filter(invtype %in% c(lots, ingrdnts),
         year%in%2015:2017) %>%
  mutate(invtype = reorder(invtype, -(TotalCBD))) %>%
  spread(year, TotalCBD) %>%
  kable(digits=1, caption='Average CBD %s', align="lcccccccccc")

potencyMonthly %>% 
  filter(!invtype%in%c(retailOther, retailFlower)) %>%
  mutate(invtype = reorder(invtype, -(TotalCBDs))) %>%
  ggplot(aes(x=date, y=TotalCBDs, color=invtype)) + geom_point() + geom_line() + theme_minimal() +
  labs(title="Ingredient Products", y='CBD%', color="Ingredient")

```

```{r}
potencyAnnual %>% 
  select(-TotalTHC, -inventorytype) %>%
  filter(invtype%in%c(retailOther, retailFlower)) %>%
  ungroup %>%
  mutate(invtype = reorder(invtype, -(TotalCBD))) %>%
  spread(year, TotalCBD) %>%
  kable(digits=1, caption='Ingredient Average CBD Concentrations, by Year', align="lcccccccccc")

potencyMonthly %>% 
  filter(invtype%in%c(retailOther, retailFlower)) %>%
    mutate(invtype = reorder(invtype, -(TotalCBDs))) %>%
  ggplot(aes(x=date, y=TotalCBDs, color=invtype)) + geom_point() + geom_line() + theme_minimal() +
  labs(title="Retail Products", y='CBD%', color="Retail Product")

```



<!-- ## Harvest Analysis -->

<!-- For this section, I will paste in data from Kee Won's analysis. Unfortunately that is not present in this DOCX but can be seen in the accompanying document. -->

<!-- + Plants, Harvest Weight, Harvest per plant. See .docx -->

<!-- ### Waste? -->

<!-- We have not produced estimates for "waste" during harvest. That is possible but not yet done. We do not currently know a place in the database that tracks "waste" at other parts of the supply chain. -->

<!-- ## Production Volumes -->

<!-- Plant and bulk flower have been omitted from these tables as they are not well recorded in the conversions table. -->

<!-- ### Lots -->

<!-- For reasons relating to how data was stored in the database, data on production of lots is not available until December 2015. -->

<!-- ```{r} -->
<!-- # summary table: show kg produced by year-quarter -->
<!-- convChildT %>% -->
<!--   filter(inventorytype%in%lots) %>% -->
<!--   mutate(q = cut(month, c(0, 3.1, 6.1, 9.1, 12.1), labels=1:4), -->
<!--          h = cut(month, c(0, 6.1, 12.1), labels=1:2), -->
<!--          yearq = paste0(year,"-", q), -->
<!--          yearh = paste0(year,"-", h)) %>% -->
<!--   group_by(inventorytype, yearh) %>% -->
<!--   summarise(MT = sum(childwt)/1e6) %>% -->
<!--   spread(yearh, MT) %>% -->
<!--   arrange(-`2017-1`) %>% -->
<!--   select(-`2014-2`, -`2015-1`, -`2015-2`) %>% -->
<!--   rename("Ingredient" = inventorytype) %>% -->
<!--   kable(digits=1, caption="Production Volume (MT)", align="lccccccc") -->
<!-- ``` -->

<!-- ### Ingredients -->

<!-- ```{r} -->
<!-- # summary table: show kg produced by year-quarter -->
<!-- convChildT %>% -->
<!--   filter(inventorytype%in%ingrdnts) %>% -->
<!--   mutate(q = cut(month, c(0, 3.1, 6.1, 9.1, 12.1), labels=1:4), -->
<!--          h = cut(month, c(0, 6.1, 12.1), labels=1:2), -->
<!--          yearq = paste0(year,"-", q), -->
<!--          yearh = paste0(year,"-", h)) %>% -->
<!--   group_by(inventorytype, yearh) %>% -->
<!--   summarise(KG = sum(childwt)/1e3) %>% -->
<!--   spread(yearh, KG) %>% -->
<!--   arrange(-`2017-1`) %>% -->
<!--   rename("Ingredient" = inventorytype) %>% -->
<!--   kable(digits=0, caption="Production Volume (KG)", align="lcccccccccc") -->

<!-- ``` -->

<!-- ### Retail -->

<!-- ```{r} -->
<!-- convChildT %>% -->
<!--   filter(inventorytype%in%retailOther) %>% -->
<!--   mutate(q = cut(month, c(0, 3.1, 6.1, 9.1, 12.1), labels=1:4), -->
<!--          h = cut(month, c(0, 6.1, 12.1), labels=1:2), -->
<!--          yearq = paste0(year,"-", q), -->
<!--          yearh = paste0(year,"-", h)) %>% -->
<!--   group_by(inventorytype, yearh) %>% -->
<!--   summarise(KG = sum(childwt)/1e3) %>% -->
<!--   spread(yearh, KG) %>% -->
<!--   arrange(-`2017-1`) %>% -->
<!--   filter(!is.na(`2016-2`)) %>% -->
<!--   rename("Retail Products (Extract-Based)" = inventorytype) %>% -->
<!--   kable(digits=0, caption="Production Volume, Units (1000s)", align="lcccccccccc") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- # Note: verified to be KG (usable weight) -->
<!-- convChildT %>% -->
<!--   filter(inventorytype%in%c(retailFlower, retailOther), -->
<!--          inventorytype%in%has_usableweight) %>% -->
<!--   mutate(q = cut(month, c(0, 3.1, 6.1, 9.1, 12.1), labels=1:4), -->
<!--          h = cut(month, c(0, 6.1, 12.1), labels=1:2), -->
<!--          yearq = paste0(year,"-", q), -->
<!--          yearh = paste0(year,"-", h)) %>% -->
<!--   group_by(inventorytype, yearh) %>% -->
<!--   summarise(KGusable = sum(childusablewt)/1e3) %>% -->
<!--   spread(yearh, KGusable) %>% -->
<!--   arrange(-`2017-1`) %>% -->
<!--   rename("Retail Products" = inventorytype) %>% -->
<!--   kable(digits=0, caption="Production Volume, Net Weight (KG)", align="lcccccccccc") -->
<!-- ``` -->



<!-- ## THC by weight -->

<!-- ### Ingredients -->

<!-- ### Retail -->

<!-- ```{r estkgTHC, eval=F} -->
<!-- # TODO: fix this; must add concentrations by the weights per month! -->
<!-- # Estimate kgTHC for retail products (TotalTHC % * KG) -->
<!-- convChild %>% -->
<!--   filter(inventorytype%in%c(retailOther, retailFlower)) %>% -->
<!--   select(inventorytype, Units=childwt, G=childusablewt) %>% -->
<!--   left_join(potencyAnnual %>% -->
<!--                filter(Year==2017) %>% select(-Year), -->
<!--              by=c('inventorytype'='invtype')) %>% -->
<!--   mutate(kgTHC = G * TotalTHC / 1e6, -->
<!--          kgCBD = G * TotalCBD / 1e6) %>% -->
<!--   mutate(KG = G / 1e3, -->
<!--          UnitsK = Units /1e3) %>%  -->
<!--   ungroup %>% -->
<!--   select(inventorytype, UnitsK, KG, THC=TotalTHC, CBD=TotalCBD, kgTHC, kgCBD) %>% -->
<!--   arrange(-UnitsK) %>% -->
<!--   kable(digits=1, caption="Retail Products: THC/CBD Concentrations and Weights", align="lcccccccccc") -->
<!-- ``` -->

<!-- ## 4D. Farmgate revenue (by producer/processor good) -->

<!-- ### Plants/Harvest/Lotted Material (Producers) -->

<!-- This contains non-processed inputs. -->



<!-- ```{r} -->

<!-- transfersYr %>% -->
<!--   filter(inventorytype %in%c(plants, lots)) %>% -->
<!--   select(kUSD, year, inventorytype) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(kUSD))) %>% -->
<!--   spread(inventorytype, kUSD) %>% -->
<!--   kable(caption="$1000 sales", digits=1) -->

<!-- transfersYr %>% -->
<!--   filter(inventorytype %in%c(plants, lots)) %>% -->
<!--   select(units, year, inventorytype) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(units))) %>% -->
<!--   spread(inventorytype, units) %>% -->
<!--   kable(caption="1000 units", digits=1) -->

<!-- transfersYr %>% -->
<!--   filter(inventorytype %in%c(plants, lots)) %>% -->
<!--   select(kgusable, year, inventorytype) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(kgusable))) %>% -->
<!--   spread(inventorytype, kgusable) %>% -->
<!--   kable(caption="kgusable", digits=1) -->

<!-- transfersYrMo %>% -->
<!--   filter(inventorytype %in%c(plants, lots)) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(units))) %>% -->
<!--   ggplot(aes(x=date, y=units/1e3, color=inventorytype)) + geom_line() + theme_minimal() + -->
<!--   labs(title="Plant and Lot Sales by Units (1000)") -->

<!-- transfersYrMo %>% -->
<!--   filter(inventorytype %in%c(plants, lots)) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(kUSD))) %>% -->
<!--   ggplot(aes(x=date, y=kUSD, color=inventorytype)) + geom_line() + theme_minimal() + -->
<!--   labs(title="Plant and Lot Sales by $1000s") -->
<!-- ``` -->

<!-- ###  (Processors) -->

<!-- This contains procesed inputs -->

<!-- ```{r} -->
<!-- transfers %>% -->
<!--   filter(invtype %in% ingrdnts) %>% arrange(-nTransfers) %>% select(-usableweight) %>%  -->
<!--   kable(digits=2, caption="All-time production") -->

<!-- transfersYr %>% -->
<!--   filter(inventorytype %in%ingrdnts) %>% -->
<!--   select(kUSD, year, inventorytype) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(kUSD))) %>% -->
<!--   spread(inventorytype, kUSD) %>% -->
<!--   kable(caption="$1000 sales", digits=1) -->

<!-- transfersYr %>% -->
<!--   filter(inventorytype %in%ingrdnts) %>% -->
<!--   select(units, year, inventorytype) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(units))) %>% -->
<!--   spread(inventorytype, units) %>% -->
<!--   kable(caption="1000 units", digits=1) -->

<!-- transfersYr %>% -->
<!--   filter(inventorytype %in%ingrdnts) %>% -->
<!--   select(kgusable, year, inventorytype) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(kgusable))) %>% -->
<!--   spread(inventorytype, kgusable) %>% -->
<!--   kable(caption="kgusable", digits=1) -->

<!-- transfersYrMo %>% -->
<!--   filter(inventorytype %in%ingrdnts) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(units))) %>% -->
<!--   ggplot(aes(x=date, y=units/1e3, color=inventorytype)) + geom_line() + -->
<!--   labs(title="Ingredient Sales by Units (1000)") -->

<!-- transfersYrMo %>% -->
<!--   filter(inventorytype %in%ingrdnts) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(kUSD))) %>% -->
<!--   ggplot(aes(x=date, y=kUSD, color=inventorytype)) + geom_line() + theme_minimal() + -->
<!--   labs(title="Ingredient Sales by $1000s") -->

<!-- ``` -->

<!-- ### Retail Products -->

<!-- This examines only retail products. -->

<!-- ```{r} -->
<!-- transfers %>% -->
<!--   filter(invtype %in% c(retailFlower, retailOther)) %>%  -->
<!--   mutate(pricePerG = saleprice/usableweight) %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(nTransfers))) %>% -->
<!--   arrange(-nTransfers) %>%  -->
<!--   kable(digits=2, caption='All-time production', align="lcccccccccc") -->
<!-- ``` -->


<!-- ```{r, fig.width=10} -->

<!-- transfersYr %>% -->
<!--   filter(inventorytype %in% c(retailFlower, retailOther)) %>% -->
<!--   arrange(-units) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(unitsK))) %>% -->
<!--   select(year, inventorytype, unitsK) %>% -->
<!--   spread(inventorytype, unitsK)%>%  -->
<!--   kable(digits=2, caption='1000 units', align="lcccccccccc") -->

<!-- transfersYr %>% -->
<!--   filter(inventorytype %in% c(retailFlower, retailOther)) %>% -->
<!--   arrange(-kUSD) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(kUSD))) %>% -->
<!--   select(year, inventorytype, kUSD) %>% -->
<!--   spread(inventorytype, kUSD)%>%  -->
<!--   kable(digits=2, caption='$1000s', align="lcccccccccc") -->

<!-- transfersYrMo %>% -->
<!--   filter(inventorytype %in% c(retailFlower, retailOther)) %>% -->
<!--   gather(metric, value, units, kgusable, kUSD) %>% -->
<!--   ungroup %>% -->
<!--   mutate(inventorytype = reorder(inventorytype, -(value))) %>% -->
<!--   filter(metric!='kgusable') %>% -->
<!--   ggplot(aes(x=date, y=value, color=inventorytype)) + geom_line() + -->
<!--   facet_grid(metric~., scales='free') + -->
<!--   labs(title="Retail Production: $, Units, Price-per-kg-usableweight") + -->
<!--   theme_minimal() -->

<!-- ``` -->

<!-- ## 4E. Retail Products -->

<!-- ### 4Ei: Sales: (Units, $) - by product type -->

<!-- #### Sales Volume (Units) -->

<!-- ```{r, echo=FALSE} -->
<!-- # TODO: Update query for proper unit/item-transaction definition -->
<!-- # Chart -->
<!-- retailUSDxType %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(itemtransactions))) %>% -->
<!--   ggplot(aes(x=date, y=itemtransactions, color=invtype)) + geom_line() + -->
<!--   labs(title="Retail Item-Transactions by Inventory Type", -->
<!--        y="Item-transactions (retail data rows)", -->
<!--        x="") + -->
<!--   theme_minimal() + -->
<!--   scale_x_date(date_labels = "%b '%y", date_breaks="6 months") -->


<!-- # Table - monthly -->
<!-- # retailUSDxType %>% -->
<!-- #   select(invtype, date, itemtransactions) %>% -->
<!-- #   spread(invtype, itemtransactions) %>% -->
<!-- #   knitr::kable(caption='Retail Item-Transactions By Inventory Type', digits=0) -->

<!-- # Table - annual -->
<!-- retailUSDxType %>% -->
<!--   group_by(YEAR, invtype) %>% -->
<!--   summarise(itemtransactions = sum(itemtransactions, na.rm=T)) %>% -->
<!--   select(invtype, YEAR, itemtransactions) %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(itemtransactions))) %>% -->
<!--   spread(invtype, itemtransactions) %>% -->
<!--   knitr::kable(caption='Retail Item-Transactions By Inventory Type - Annual', digits=0, align="lcccccccccc") -->

<!-- ``` -->

<!-- #### Sales Volume (Usable Weight) -->

<!-- Note: this is validated by tabulating usableweight sold in the retail table! (at least for usable MJ) -->

<!-- ```{r, echo=FALSE} -->
<!-- # TODO: Update query for proper unit/item-transaction definition -->
<!-- # Chart -->
<!-- retailUSDxType %>% -->
<!--   filter(usableweight >0 ) %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(usableweight))) %>% -->
<!--   ggplot(aes(x=date, y=usableweight/1e6, color=invtype)) + geom_line() + -->
<!--   labs(title="Retail Item-Transactions by Inventory Type", -->
<!--        y="usable weight (MT)", -->
<!--        x="") + -->
<!--   theme_minimal() + -->
<!--   scale_x_date(date_labels = "%b '%y", date_breaks="6 months") -->


<!-- # Table - monthly -->
<!-- # retailUSDxType %>% -->
<!-- #   select(invtype, date, itemtransactions) %>% -->
<!-- #   spread(invtype, itemtransactions) %>% -->
<!-- #   knitr::kable(caption='Retail Item-Transactions By Inventory Type', digits=0) -->

<!-- # Table - annual -->
<!-- retailUSDxType %>% -->
<!--   filter(usableweight >0 ) %>% -->
<!--   group_by(YEAR, invtype) %>% -->
<!--   summarise(usableweight = sum(usableweight, na.rm=T)/1e6) %>% -->
<!--   select(invtype, YEAR, usableweight) %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(usableweight))) %>% -->
<!--   spread(YEAR, usableweight) %>% -->
<!--   knitr::kable(caption='Usable Weight (MT) By Inventory Type - Annual', digits=2, align="lcccccccccc") -->
<!-- ``` -->

<!-- #### Sales Volume (Dollars) -->

<!-- ```{r, echo=FALSE} -->
<!-- # Chart -->
<!-- retailUSDxType %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(price_x))) %>% -->
<!--   ggplot(aes(x=date, y=price_x, color=invtype)) + geom_line() + -->
<!--   labs(title="Gross Retail Sales by Inventory Type", -->
<!--        y="$1000, Post-Excise", -->
<!--        x="") + -->
<!--   theme_minimal() + -->
<!--   scale_x_date(date_labels = "%b '%y", date_breaks="6 months") + -->
<!--   scale_y_continuous(labels=scales::dollar_format()) -->


<!-- # Table -->
<!-- # retailUSDxType %>% -->
<!-- #   select(invtype, date, price_x) %>% -->
<!-- #   spread(invtype, price_x) %>% -->
<!-- #   knitr::kable(caption='Post-Excise Tax Sales By Inventory Type ($1k)', digits=0) -->


<!-- # Table - annual -->
<!-- retailUSDxType %>% -->
<!--   group_by(YEAR, invtype) %>% -->
<!--   summarise(price_x = sum(price_x)) %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(price_x))) %>% -->
<!--   select(invtype, YEAR, price_x) %>% -->
<!--   spread(invtype, price_x) %>% -->
<!--   knitr::kable(caption='Post-Excise Tax Sales By Inventory Type ($1k) - Annual', digits=0, align="lcccccccccc") -->

<!-- ``` -->


<!-- ### 4Eii:THC/CBD Content -->

<!-- ```{r load_edibles_thc, echo=F} -->
<!-- edible_thc <- read.csv("../data/THC_estimates_nocbddominantedibles.csv") %>% -->
<!--   mutate(date=make_date(year, month)) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE} -->
<!-- edible_thc %>%  -->
<!--   filter(str_detect(invtype, "Edible")) %>% -->
<!--   ggplot(aes(x=date, y=kgTHC, fill=invtype)) + geom_col() +  -->
<!--   labs(title='Edbiles: kgTHC sold', -->
<!--        caption="Counting THC-dominant edibles only") -->

<!-- edible_thc %>%  -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(kgTHC))) %>% -->
<!--   ggplot(aes(x=date, y=kgTHC, fill=invtype)) + geom_col() +  -->
<!--   labs(title='kgTHC sold', -->
<!--        caption="Counting THC-dominant edibles only") -->


<!-- # TODO: Update query for weighted averages -->
<!-- # Chart -->
<!-- retailUSDxType %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(totalTHC))) %>% -->
<!--   ggplot(aes(x=date, y=totalTHC, color=invtype)) + geom_line() + -->
<!--   labs(title="THC Content by Inventory Type", -->
<!--        y="THC Percent", -->
<!--        x="") + -->
<!--   theme_minimal() + -->
<!--   scale_x_date(date_labels = "%b '%y", date_breaks="6 months") -->


<!-- # Table -->
<!-- # retailUSDxType %>% -->
<!-- #   select(invtype, date, totalTHC) %>% -->
<!-- #   spread(invtype, totalTHC) %>% -->
<!-- #   knitr::kable(caption='Mean THC Content By Inventory Type', digits=0) -->

<!-- retailUSDxType %>% -->
<!--   group_by(YEAR, invtype) %>% -->
<!--   summarise(totalTHC = weighted.mean(totalTHC, price_x)) %>% -->
<!--   select(invtype, YEAR, totalTHC) %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(totalTHC))) %>% -->
<!--   spread(invtype, totalTHC) %>% -->
<!--   knitr::kable(caption='Mean THC Content By Inventory Type (Weighted by $ Sales) - Annual', digits=1, align="lcccccccccc") -->

<!-- ``` -->

<!-- #### Edibles Only -->



<!-- ```{r, echo=FALSE} -->
<!-- # TODO: Update query for weighted averages -->
<!-- # Chart -->
<!-- retailUSDxType %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(totalCBD))) %>% -->
<!--   ggplot(aes(x=date, y=totalCBD, color=invtype)) + geom_line() + -->
<!--   labs(title="CBD Content by Inventory Type", -->
<!--        y="CBD Percent", -->
<!--        x="") + -->
<!--   theme_minimal() + -->
<!--   scale_x_date(date_labels = "%b '%y", date_breaks="6 months") -->


<!-- # Table -->
<!-- # retailUSDxType %>% -->
<!-- #   select(invtype, date, totalCBD) %>% -->
<!-- #   spread(invtype, totalCBD) %>% -->
<!-- #   knitr::kable(caption='Mean CBD Content By Inventory Type', digits=0) -->

<!-- retailUSDxType %>% -->
<!--   group_by(YEAR, invtype) %>% -->
<!--   summarise(totalCBD = weighted.mean(totalCBD, price_x)) %>% -->
<!--   ungroup %>% -->
<!--   mutate(invtype = reorder(invtype, -(totalCBD))) %>% -->
<!--   select(invtype, YEAR, totalCBD) %>% -->
<!--   spread(invtype, totalCBD) %>% -->
<!--   knitr::kable(caption='Mean CBD Content By Inventory Type (Weighted by $ Sales) - Annual', digits=1, align="lcccccccccc") -->

<!-- ``` -->

<!-- ## 4F. Supply Chain Dynamics: Product Flows and Conversion Ratios -->

<!-- ** TODO: Add analysis from the pathways document?** -->

<!-- #### 4Fi.	Efficiency: Flower/OPM-per-ingredient (gram-to-gram ratio). Conversion Ratios (inventoryconversions) -->

<!-- This data needs substantial cleaning (top-censoring the parent and child weights; allowing usablewt to be interpretable by performing the correct wt*usableweight calculations (perhaps also requiring top-coding or some other conditional logic to prevent absurd values)) before it can be interpretable. -->

<!-- ```{r} -->
<!-- # TODO: clean childusableweight when it an childwt is present. -->
<!-- ratiosRaw <- convDetailed %>% -->
<!--   group_by(parent, child) %>% -->
<!--   summarise(conversions = sum(nConversions), -->
<!--             ratiowt2wt = sum(parentwt, na.rm=T)/sum(childwt, na.rm=T), -->
<!--             ratiowt2uwt = sum(parentwt, na.rm=T)/sum(childusablewt, na.rm=T), -->
<!--             ttlparentwt = sum(parentwt, na.rm=T), -->
<!--             ttlchildwt = sum(childwt, na.rm=T), -->
<!--             ttlchilduwt = sum(childusablewt, na.rm=T), -->
<!--             # ttlchildwtXuwt = sum(childwt*childusablewt, na.rm=T), -->
<!--             ratiowt2wtXuwt = sum(parentwt, na.rm=T)/sum(childusablewt * childwt, na.rm=T) -->
<!--             ) %>% -->
<!--   arrange(-conversions) -->

<!-- kable(ratiosRaw, digits=2) -->
<!-- ``` -->

<!-- ##### (wet?) Flower / OPM – to –  ingredient… (Hydrocarbon wax; CO2 Hash Oil;  Food Grade Solvent Extract)... -->

<!-- ##### Flower / OPM – to – final product (Extract, Solid / Liquid Edible, etc.) -->



<!-- #### 4Fii. End products as share of canopy: -->

<!-- ### Conversion Pathway Prevalence -->

<!-- The table below produces a simple count of the number of records in each. -->

<!-- ```{r} -->
<!-- convPaths %>% head(50) %>% kable(caption="Dominant Conversion Pathways") -->
<!-- ``` -->

<!-- [[ compute pathway prevalence in percentage terms, a la Markov chain, and put results here ]] -->


<!-- ##### Retail products by % of flower/OPM production (by weight) -->

<!-- ##### by % of “all” production -->


<!-- ## Licensee Revenue Analysis -->

<!-- ### Producer/P&P/Processors -->

<!-- This can be generated from inventorytransfers table. inventorytransfer::saleprice. Validate/verify this. (5.3mil records) -->


<!-- ```{r} -->
<!-- # GoogleQuery: ????? -->

<!-- # Aggregate revenues for all producers. -->

<!-- ``` -->

<!-- ### Stores -->

<!-- This can be generated from the dispensing table. -->


<!-- ## Harvest -->

<!-- [[ Results will go here ]]   -->
<!-- [[ kg harvest of wet flower, dry flower, OPM, and waste]]  -->

<!-- And the 5 most popular child products (data needs cleaning): -->

<!-- ```{r} -->
<!-- convDetailed %>% -->
<!--   filter(!child %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"), -->
<!--          !child %in% c("Usable Marijuana")) %>% -->
<!--   group_by(child) %>% -->
<!--   summarise(nConversions = sum(nConversions), -->
<!--            childwt = sum(childwt, na.rm=T), -->
<!--            childusablewt = sum(childusablewt, na.rm=T)) %>% -->
<!--   arrange(-childwt) %>% -->
<!--   head(5) %>% -->
<!--   kable(caption='inventoryconversion children') -->
<!-- ``` -->

<!-- Though it is less interesting, we can also tabulate data by parent type. This can be used to validate. -->


<!-- ```{r, eval = F, include=F} -->
<!-- # Queries -->


<!-- # QUERY: Get weight of harvested material. This crashes Google Query. -->
<!-- SELECT location, plantid, MIN(sessiontime) AS firstharvest, -->
<!-- SUM(CASE WHEN inventorytype = 29 THEN dweight else 0 END) as wet_weight, -->
<!-- SUM(CASE WHEN inventorytype = 6 THEN dweight else 0 END) as dry_weight, -->
<!-- SUM(CASE WHEN inventorytype = 9 THEN dweight else 0 END) as opm_weight -->
<!-- FROM [rand-systems:full_WA_data__proper.biotrackthc_plantderivatives] -->
<!-- -- remove deleted records -->
<!-- WHERE deleted = 0 -->
<!-- GROUP BY location, plantid, inventorytype; -->

<!-- # SIMPLER (Crash-proof?): Get weight of harvested material. -->
<!-- SELECT location, -->
<!-- SUM(CASE WHEN inventorytype = 29 THEN dweight else 0 END) as wet_weight, -->
<!-- SUM(CASE WHEN inventorytype = 6 THEN dweight else 0 END) as dry_weight, -->
<!-- SUM(CASE WHEN inventorytype = 9 THEN dweight else 0 END) as opm_weight -->
<!-- FROM [rand-systems:full_WA_data__proper.biotrackthc_plantderivatives] -->
<!-- -- remove deleted records -->
<!-- WHERE deleted = 0 -->
<!-- GROUP BY location, inventorytype; -->

<!-- # RUN THIS QUERY -->

<!-- # This query is saved in the table: plant_stats_distinct_location -->
<!-- # select a.location AS location, b.locationtype AS locationtype, a.plantid AS plantid, -->
<!-- # a.sessiontime AS sessiontime, a.wet_weight AS wet_weight, a.dry_weight AS dry_weight, -->
<!-- # a.opm_weight AS opm_weight -->
<!-- # from [rand-systems:TEAM_WORKSPACE_USE_ME.plant_stats_distinct] a -->
<!-- # JOIN ( -->
<!-- # select id, locationtype -->
<!-- # FROM -->
<!-- # [rand-systems:full_WA_data__proper.biotrackthc_locations]) b ON a.location =b.id -->
<!-- # WHERE b.locationtype < 7; -->
<!-- ``` -->

<!-- ### Production Volumes -->

<!-- ## Processing / Manufacturing -->

<!-- This sub-section includes: 1) production volumes, 2) pathway prevalence, 3) conversion ratios -->



<!-- ## Appendix -->

<!-- ### Validation -->

<!-- We can check usable weight v weight tables in retail and inventoryconversions. -->

<!-- + Spike in usable marijuana production early 2017 by usableweight. Fixed by top-coding usable marijuana uw:w ratio @ 1 ounce. -->
<!-- + spike in MJ mix for usable weight. -->

<!-- ```{r, eval = F} -->
<!-- # USE THIS SCRIPT TO DETECT AND TOPCODE OUTLIERS  (i.e. for histograms with outliers) -->
<!-- convChildT %>% -->
<!--   mutate(ratio=childusablewt/childwt) %>% -->
<!--   ggplot() + geom_histogram(aes(x=ratio, fill=inventorytype)) + facet_wrap(~inventorytype, scales='free') -->

<!-- # View in table -->
<!-- convChildT %>% -->
<!--   # filter(inventorytype == "Marijuana Mix") %>% -->
<!--   arrange(-uwper) #%>% -->
<!--   group_by(year, month, inventorytype) %>% -->
<!--   summarise(nConversions = sum(nConversions), -->
<!--             childwt = sum(childwt), -->
<!--             childusablewt = sum(childusablewt), -->
<!--             ratio = childusablewt/childwt) -->


<!-- convChildT %>% -->
<!--   filter(inventorytype == "Marijuana Mix") %>% -->
<!--   mutate(wtper = childwt / nConversions) %>% -->
<!--   arrange(-wtper)  -->

<!-- ``` -->

<!-- ### Lots -->

<!-- ```{r} -->
<!-- # For these, "weight" is the same as "usableweight" -->
<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%lots) %>% -->
<!--   ggplot(aes(x=date, y=nConversions/1e3, color=inventorytype)) + -->
<!--   geom_line() + theme_minimal() +geom_point() + -->
<!--   labs(title="Lots Produced", -->
<!--        y="1000 Conversions") -->

<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%lots) %>% -->
<!--   ggplot(aes(x=date, y=childwt/1e6, color=inventorytype)) + geom_line() + theme_minimal() +geom_point() + -->
<!--   labs(title="Lots Produced", -->
<!--        y='1000 KG ("weight")') -->
<!-- ``` -->

<!-- ### Ingredient Production (reliable?) -->

<!-- TODO: validate usableweight and weight. Weight appears to indicate literal weight. Usableweight must be miscoded, as it is >> weight. -->

<!-- ```{r} -->
<!-- # TODO: clean childwt to remove outliers. Currently you have way too much childwt going to Extract for Inhalation and nConversions! -->




<!-- # Production of ingredient, 10 time periods, Units, chart -->

<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%ingrdnts) %>% -->
<!--   ggplot(aes(x=date, y=nConversions/1e3, color=inventorytype)) + -->
<!--   geom_line() + theme_minimal() +geom_point() + -->
<!--   labs(title="Ingredient Products Produced", -->
<!--        y="1000 Conversions") -->

<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%ingrdnts) %>% -->
<!--   ggplot(aes(x=date, y=childwt/1e3, color=inventorytype)) + -->
<!--   geom_line() + theme_minimal() +geom_point() + -->
<!--   labs(title="Weight of Ingredient Products Produced", -->
<!--        y="weight (KG) Converted") -->

<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%ingrdnts) %>% -->
<!--   ggplot(aes(x=date, y=childusablewt/1e3, color=inventorytype)) + -->
<!--   geom_line() + theme_minimal() +geom_point() + -->
<!--   labs(title="Usable weight of Ingredient Products Produced -- PROB NOT RELIABLE", -->
<!--        y="Usable Weight (KG) Converted") -->


<!-- # summary table: show kg produced by year-quarter -->
<!-- convChildT %>% -->
<!--   filter(inventorytype%in%ingrdnts) %>% -->
<!--   mutate(q = cut(month, c(0, 3.1, 6.1, 9.1, 12.1), labels=1:4), -->
<!--          h = cut(month, c(0, 6.1, 12.1), labels=1:2), -->
<!--          yearq = paste0(year,"-", q), -->
<!--          yearh = paste0(year,"-", h)) %>% -->
<!--   group_by(inventorytype, yearh) %>% -->
<!--   summarise(KG = sum(childusablewt)/1e3) %>% -->
<!--   spread(yearh, KG) %>% -->
<!--   arrange(-`2017-1`) %>% -->
<!--   filter(!is.na(`2016-2`)) %>% -->
<!--   kable(digits=1, caption="Ingredient Production (KG) by 6-month period") -->

<!-- ``` -->

<!-- ### Retail production -->

<!-- TODO: find out how to interpret weight v usable weight!!! These are bullshit. You need to go into the tables and figure out what is what. -->

<!-- ```{r} -->
<!-- # RETAIL FLOWER (USABLEMJ and MJMIXPACKAGE) -->
<!-- # WEight -->
<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%retailFlower) %>% -->
<!--   ggplot(aes(x=date, y=childwt/1e3, color=inventorytype)) + -->
<!--   geom_line() + theme_minimal() +geom_point() + -->
<!--   facet_grid(inventorytype~., scales='free') + -->
<!--   labs(title="Production ('weight'): Usable MJ / MJ Mix Package: ", -->
<!--        y="weight (KG) Converted") -->

<!-- #Usableweight -->
<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%retailFlower) %>% -->
<!--   ggplot(aes(x=date, y=childusablewt/1e3, color=inventorytype)) + -->
<!--   geom_line() + theme_minimal() +geom_point() + -->
<!--   facet_grid(inventorytype~., scales='free') + -->
<!--     labs(title="Production ('usable weight'): Usable MJ / MJ Mix Package: ", -->
<!--        y="Suable weight (KG) Converted") -->

<!-- # OTHER  RETAIL -->
<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%retailOther) %>% -->
<!--   ggplot(aes(x=date, y=nConversions/1e3, color=inventorytype)) + -->
<!--   geom_line() + theme_minimal() +geom_point() + -->
<!--   labs(title="Number of Ingredient Products Produced", -->
<!--        y="1000 Conversions") -->

<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%retailOther) %>% -->
<!--   ggplot(aes(x=date, y=childwt/1e3, color=inventorytype)) + -->
<!--   geom_line() + theme_minimal() +geom_point() + -->
<!--   labs(title="Weight of Ingredient Products Produced", -->
<!--        y="weight (KG) Converted") -->

<!-- convChildTYrMo %>% -->
<!--   filter(inventorytype%in%retailOther) %>% -->
<!--   ggplot(aes(x=date, y=childusablewt/1e3, color=inventorytype)) + -->
<!--   geom_line() + theme_minimal() +geom_point() + -->
<!--   labs(title="Usable weight of Ingredient Products Produced", -->
<!--        y="Usable Weight (KG) Converted") -->
<!-- ``` -->

<!-- ## Notes on workflow / tables -->

<!-- ### plantderivatives (Harvest Events) -->

<!-- The "plantderivatives" table records the harvesting from plants of dry flower, wet flower, other plant material, and waste. Aggregations are calculated by adding **dweight** after cleaning, top-censored based on harvest-per-plant (at 1.5kg each **?**). **dwholeweight** records the entire harvest weight across many plants; **dweight** apportions an equal fraction of this across all plants harvested.  -->

<!-- **Notes** -->

<!-- + inventory::waste record count: 989,387  -->
<!-- + sum(inventory::waste[inventorytype==26]) > 600mil kg (assuming units = gram) -->
<!-- + Almost all dry flower has inventoryid. Many plants have a wet weight but no dry weight, e.g. 250,000 plants in November 2017 due to end of traceability reporting. -->


<!-- ### inventorycombinations (Lotting Events) -->

<!-- The "inventorycombinations" table records the combination of individual raw production units to aggregate lots.  The input types to this process are Dry Flower (inventorytype 6) and Other Plant Material (9). Lotted units include Flower lot (13), OPM lot (14), and marijuana mix (30). I speculate that inventorycombinations is essentially inventoryconversions but for same-type converrsions (e.g. flower lot - flower lot), as most entries have an NA parent-type and only an inventorytype for children. There are a few entries with different-type conversions, but these are likely errors. -->

<!-- TODOs -->

<!-- + Verify understanding that table captures all same-type conversions (i.e. combinations), and this explains why often oldtype = NA. -->
<!-- + Data cleaning: Quantities of the parent ("parent_difference") and child ("childweight", "child_usableweight"). Top-censor values, e.g., at 99%ile by parent/child inventorytype. -->
<!-- + very regulations to verify max parent lot sizes (5kg flower lot /10kg OPM lost). -->

<!-- ```{r} -->
<!-- # TODO: after parsing SESSIONTIME, add year-month to query. -->
<!-- # Query (lotQuery): simple count of lots -->
<!-- # -- Count the number of lots made (by input/output type) over time, statewide -->
<!-- # SELECT OLDTYPE, NEWTYPE, count(*) as numlots -->
<!-- # FROM [full_WA_data__proper.biotrackthc_inventorycombinations] -->
<!-- # GROUP BY oldtype, newtype -->

<!-- lots <- read_csv("../gqoutput/results-20180630-122340.csv") %>% -->
<!--   mutate(OLDTYPE = getInvtype(OLDTYPE), -->
<!--          NEWTYPE = getInvtype(NEWTYPE) -->
<!--          ) -->
<!-- knitr::kable(lots, caption="Lot counts by input-output type") -->
<!-- ``` -->

<!-- ### inventorytransfers (Wholesale Transactions) -->

<!-- This table records all licensee-to-licensee transactions. Because the inventory transfers table has a redacted date field, we supplement it with date information merged from the "inventory" table. This provides an estimate for dates of transfers. -->


<!-- ### inventoryconversions (Processing and Manufacturing) -->

<!-- The inventory conversions table records all conversions from one inventory type to another. This is key. This table is tagged with a serial ID (allowing **time-series**) and **licensee-level** data (manufacturer of the child product), so complex analysis is possible. By merging on inventoryid, products downstream of testing can also have **THC** contents estimated. By merging with the table inventorytransfers, we ought to be able to compute all **revenue** figures too.  Data span nearly the entire supply chain: -->

<!-- + Lotting stage (flower -> flower lot) -->
<!-- + processing/manufacturing stage 1 (flower/OPM to intermediate extracts) -->
<!-- + processing/manufacturing stage 1 (intermediate extracts to retail product) -->

<!-- This table gets the finest grain of stuff (licensee x parent-type x child-type). Should also add date once we know how to parse that. -->

<!-- **Available information in this table**   -->
<!-- date, location, parentweight (always grams?), childweight, childusableweight. -->


<!-- TODOs: -->

<!-- + Add this table to the new Google Query schema ("...proper") -->
<!-- + clean childusableweight when it an childwt is present. it seems like we sometimes but not always have to multiply wt * usablewt. Until we do that, the ratios will be wrong.  -->
<!-- + Enrich inventoryconversions table with **THC** (merge on inventoryid with lab table, for eligible products). -->
<!-- + Since data is tagged only with creator license, but since it seems like this table captures all conversion pathways, many products are re-appearing in this table several times. So, attempt to create a new table that wouldu use a recursive merge to analyze with to/from licensee data? (e.g. for network analysis) -->

<!-- Below we produce a preview of the data in this table. (Date is also available but not shown here.) -->

<!-- ```{r} -->
<!-- kable(convDetailed %>% head(5)) -->
<!-- ``` -->

<!-- This table can be viewed with respect to parent or child products. Parent products include lots and all intermediate products. Child products include all intermediate products and retail products.   -->

<!-- Below we show the five most popular parent products (data needs cleaning): -->


<!-- ```{r} -->
<!-- convDetailed %>% -->
<!--   filter(!parent %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"), -->
<!--          !parent %in% c("Usable Marijuana")) %>% -->
<!--   group_by(parent) %>% -->
<!--   summarise(nConversions = sum(nConversions), -->
<!--            parentwt = sum(parentwt, na.rm=T)) %>% -->
<!--   arrange(-parentwt) %>% -->
<!--   head(5) %>% -->
<!--   kable(caption='inventoryconversion parents') -->
<!-- ``` -->

<!-- ## Validation -->

<!-- Here are miscellaneous tables. -->

<!-- ### Audit harvest v lots v conversion-parents -->

<!-- Lots are produced in the inventorycombinations table (from dry flower or OPM), before they then re-appear in the inventoryconversions table for conversions to other products. Therefore we can use these two tables (after cleaning) to validate the data. We will triangulate this from various tables: -->

<!-- + inventorycombinations - lotting -->
<!-- + inventoryconversions - parent product -->
<!-- + inventoryconversions - child product -->

<!-- ```{r} -->
<!-- lots %>%  -->
<!--   group_by(NEWTYPE) %>% -->
<!--   summarise(numlots = sum(numlots)) %>% -->
<!--   kable(caption="Number of lots from inventorycombinations") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- # Plot kg weight -->
<!-- convDetailedT %>% -->
<!--   filter(parent %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"), -->
<!--          (year != 2017 & month !=11)) %>% -->
<!--   group_by(parent, month, year) %>% -->
<!--   summarise(nConversions = sum(nConversions), -->
<!--            parentwt = sum(parentwt, na.rm=T)) %>% -->
<!--   mutate(date=make_date(year, month)) %>% -->
<!--   ggplot(aes(x=date, y=parentwt/1e6, color=parent)) +  -->
<!--   geom_point() + geom_line() + -->
<!--   labs(y="kg weight", title="Production of Lots / Mix", -->
<!--        subtitle="types appear as parents in conversion table") -->

<!-- # Chart # Conversions -->
<!-- # convDetailedT %>% -->
<!-- #   filter(parent %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"), -->
<!-- #          (year != 2017 & month !=11)) %>% -->
<!-- #   group_by(parent, month, year) %>% -->
<!-- #   summarise(nConversions = sum(nConversions), -->
<!-- #            parentwt = sum(parentwt, na.rm=T)) %>% -->
<!-- #   ggplot(aes(x=month, y=nConversions/1e3, color=parent)) +  -->
<!-- #   facet_grid(~year) + -->
<!-- #   geom_point() + geom_line() + -->
<!-- #   labs(y="thousand conversions", title="Production of Lots / Mix") -->

<!-- ``` -->

<!-- ```{r} -->
<!-- convDetailedT %>% -->
<!--   filter(child %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"), -->
<!--          (year != 2017 & month !=11)) %>% -->
<!--   group_by(child, month, year) %>% -->
<!--   summarise(nConversions = sum(nConversions), -->
<!--            childwt = sum(childwt, na.rm=T), -->
<!--            childusablewt = sum(childusablewt, na.rm=T)) %>% -->
<!--   mutate(date=make_date(year, month)) %>% -->
<!--   ggplot(aes(x=date, y=childwt/1e6, color=child)) +  -->
<!--   geom_point() + geom_line() + -->
<!--   labs(y="MT weight", title="Production FROM Lots / Mix", -->
<!--        subtitle="types appear as children in conversion table") -->


<!-- convDetailedT %>% -->
<!--   filter(child %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"), -->
<!--          (year != 2017 & month !=11)) %>% -->
<!--   group_by(child, month, year) %>% -->
<!--   summarise(nConversions = sum(nConversions), -->
<!--            childwt = sum(childwt, na.rm=T), -->
<!--            childusablewt = sum(childusablewt, na.rm=T)) %>% -->
<!--   mutate(date=make_date(year, month)) %>% -->
<!--   ggplot(aes(x=date, y=childusablewt/1e6, color=child)) +  -->
<!--   geom_point() + geom_line() + -->
<!--   labs(y="MT usable weight", title="Production FROM Lots / Mix", -->
<!--        subtitle="types appear as children in conversion table") -->

<!-- convDetailedT %>% -->
<!--   filter(child %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"), -->
<!--          (year != 2017 & month !=11)) %>% -->
<!--   group_by(child, month, year) %>% -->
<!--   summarise(nConversions = sum(nConversions), -->
<!--            childwt = sum(childwt, na.rm=T), -->
<!--            childusablewt = sum(childusablewt, na.rm=T)) %>% -->
<!--   mutate(date=make_date(year, month)) %>% -->
<!--   ggplot(aes(x=date, y=nConversions/1e3, color=child)) +  -->
<!--   facet_grid(~year) + -->
<!--   geom_point() + geom_line() + -->
<!--   labs(y="thousand conversions", title="Production FROM Lots / Mix", -->
<!--        subtitle="types appear as children in conversion table") -->

<!-- ``` -->

<!-- Though it is less interesting, we can also tabulate data by parent type. This can be used to validate. -->

<!-- ### Validate Conversion-parents -->

<!-- This is not intrinsically interesting but could be used to validate harvest/lotting data. Note an average conversion-weight of almost 5000 (5kg?) for flower and 10,000 (10kg?) for OPM. -->

<!-- ```{r} -->
<!-- knitr::kable(convParent, digits=1) -->
<!-- ``` -->