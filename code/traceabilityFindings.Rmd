---
title: "Traceability-Based Findings - Sept Draft"
author: "Steven Davenport"
date: "`r format(Sys.time(), '%B %d, %Y (%H:%M)')`"
output: html_document
---

**Version history**
v1.5 - September Draft.  
v1.4 (July 3) Restructured outline; sent to JPC/BK for review.
v1.3 (June 30) restructured outline.  
v1.2 (June 30) added analysis of inventoryconversions table.  
v1.1 (June 29) clarified outline; incorporated comments from Kee Won RE methods. Was sent briefly to JPC.  
v1.0 (June 27) provided outline; finished first draft of retail tables.

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      # Graphic output
                      fig.width = 8, fig.align='center')
library(tidyverse)
library(knitr)
source("functions.r")


# Get inventory conversions
# -- QUERY
#  SELECT inventorytype, inventorytype_parent, location,
#    count(*) as nConversions,
#    sum(CAST(parent_difference as integer)) as parentwt,
#    sum(CAST(childweight as integer)) as childwt,
#    sum(CAST(child_usableweight as integer)) as childusablewt
# FROM [full_WA_data.biotrackthc_inventoryconversions]
# GROUP BY inventorytype, inventorytype_parent, location
convDetailed <- read_csv("../gqoutput/results-20180630-133936.csv") %>%
  mutate(parent = getInvtype(inventorytype_parent),
         child = getInvtype(inventorytype))  %>%
  select(-inventorytype_parent, -inventorytype) %>%
  arrange(-nConversions) # TODO: Add licensee name, date?

write.csv(convDetailed, "../output/conversionsDetailed.csv")

# Get Ingredient weights.
# -- QUERY: CHILD WEIGHTS.
#  SELECT inventorytype,
#    count(*) as nConversions,
#    sum(CAST(childweight as integer)) as childwt,
#    sum(CAST(child_usableweight as integer)) as childusablewt
# FROM [full_WA_data.biotrackthc_inventoryconversions]
# GROUP BY inventorytype
convChild <- read_csv("../gqoutput/results-20180630-131250.csv") %>%
  mutate(inventorytype = getInvtype(inventorytype),
         wtPer = childwt/nConversions,
         usablewtPer = childusablewt/nConversions)  %>%
  arrange(-childwt)

# Get Potency
# Load potency test data scores
potency <- read_csv("../data/potencytests.csv")
# clean for consistent Total THC/CBD.
potencyAnnual <-
  potency %>%
  mutate(TotalTHC = THC + 0.877 * THCA,
         TotalCBD = CBD + 0.877 * CBDA
         ) %>%
  select(TotalTHC, TotalCBD, inventorytype, invtype, test_year) %>%
  group_by(invtype, test_year) %>%
  summarise(TotalTHC = mean(TotalTHC, na.rm=T),
            TotalCBD = mean(TotalCBD, na.rm=T))
# Export file for use in estimating THC content of products!
potencyAnnual %>%
  write_csv("../data/thccbdannual.csv")


# Get data on conversion paths (e.g. for prevalence)
convPaths <- read_csv("../gqoutput/results-20180630-124915.csv") %>%
  mutate(parent = getInvtype(inventorytype_parent),
         child = getInvtype(inventorytype))  %>%
  select(parent, child, nConversions) %>%
  arrange(-nConversions)
# -- Inventory Conversion parent-child
# SELECT inventorytype, inventorytype_parent, count(*) as nConversions
# FROM [full_WA_data.biotrackthc_inventoryconversions]
# GROUP BY inventorytype, inventorytype_parent


# Get spending per year by inventory tpe
# GoogleQuery: RetailUSDxType
# TODO: replace this query with the saved version? (it was lost?)
# SELECT invtype, 
# YEAR(sale_time) as YEAR,
# MONTH(sale_time) as MONTH,
# -- number of rows (item-transactions)
# count(*) as itemtransactions,
# sum(price_x) as price_x,
# -- TODO: After remaking retail view, replace with proper "TotalTHC"
# -- TODO: Replace with weighted average, w wts varied by inventorytype
# avg(thc + thca*0.877) as totalTHC,
# -- TODO: Replace this with a cleaned version of totalCBD? (
# avg(case when cbda is null then cbd
#      when cbda is not null then cbd + cbda * 0.877
#      end) as totalCBD
#       --avg(cbd + (if is not null cbda, cbda *0.877, 0)) as totalCBD
# FROM [full_WA_data__proper.Retail_ALL]
# GROUP BY invtype, YEAR, MONTH
# ORDER BY invtype, YEAR,MONTH
retailUSDxType <- read_csv("../gqoutput/results-20180627-174927.csv") %>%
  mutate(date=make_date(YEAR, MONTH)) %>%
  # Convert to $1000s
  mutate(price_x = price_x / 1e3) %>%
  filter(
    # remove NA
    !is.na(invtype),
    # remove non-retail products in here for no reason
    !invtype%in%c("Clone", "Mature Plant"),
    # Remove the partial month of October 2017
    date <= "2017-10-01")


# Load conversion-parent table
# -- QUERY
# SELECT inventorytype_parent,
#   count(*) as nConversions,
#   sum(CAST(parent_difference as integer)) as parentwt
# FROM [full_WA_data.biotrackthc_inventoryconversions]
# GROUP BY inventorytype_parent
convParent <- read_csv("../gqoutput/results-20180630-130516.csv") %>%
  mutate(inventorytype_parent = getInvtype(inventorytype_parent)) %>%
  mutate(wtPerConv = parentwt/nConversions) %>%
  arrange(-parentwt)

# Get Transfer Volumes
# Get Ingredient weights.
# -- Query usable weight of eligible transfers
# SELECT inventorytype,
#    sum(CAST(USABLEWEIGHT as integer)) as usableweight
# FROM [full_WA_data.biotrackthc_inventorytransfers]
# WHERE USABLEWEIGHT is not null and CAST(inventorytype as integer) <=40
# GROUP BY inventorytype
# ORDER BY inventorytype
transferUsableWeight <- read_csv("../gqoutput/results-20180912-182538.csv")

# -- Query Sale Price of All Transfers
# SELECT inventorytype,
#    count(*) as nTransfers,
#    sum(CAST(saleprice as integer)) as saleprice
# FROM [full_WA_data.biotrackthc_inventorytransfers]
# WHERE saleprice is not null  and CAST(inventorytype as integer) <=40
# GROUP BY inventorytype
# ORDER BY inventorytype
transferVolumes <- read_csv("../gqoutput/results-20180912-181851.csv")

transfers <- left_join(transferVolumes, transferUsableWeight) %>%
  mutate(invtype = getInvtype(inventorytype)) %>%
  select(invtype, nTransfers, saleprice, usableweight) %>%
  mutate(pricePer = saleprice / nTransfers) 

```


## Results (Section 4)

### 4A Harvest Analysis

+ Plants, Harvest Weight, Harvest per plant. See .docx

#### Waste?

### 4B Amount Produced (Units, MT)

#### "Ingredients"

####  TODO: Re-make convchildT/convChildT10 after sorting on id?
```{r}
# TODO: clean childwt to remove outliers. Currently you have way too much childwt going to Extract for Inhalation and nConversions!
# Load version of convChild with a time dimension.
convChildT <- read.csv("../gqoutput/results-20180913-161933.csv") %>%
  mutate(inventorytype = getInvtype(inventorytype))
convChildT10 <- read.csv("../gqoutput/results-20180913-163153.csv") %>%
  mutate(inventorytype = getInvtype(inventorytype))
# Preview full table
# knitr::kable(convChild, digits=0)

# Look only at Ingredient Types
ingrdnts <- c("Hydrocarbon Wax", "Bubble Hash", "C02 Hash Oil", "Marijuana Mix", "Food Grade Solvent Extract", 
              "Infused Dairy Butter or Fat in Solid Form", "Infused Cooking Oil",
              "Hash", "Kief")

# Production of ingredient, 3 time periods, KG, table
convChildT %>%
  select(inventorytype, Units=childweight, G =child_usableweight, t=range) %>%
  mutate(KG=G/1e3) %>%
  filter(inventorytype%in%ingrdnts) %>%
  select(-G) %>%
  arrange(-KG) %>%
  select(inventorytype, KG, t) %>%
  spread(t, KG) %>%
  arrange(-`3`) %>%
  kable(digits=1, caption="Kg of each ingredient product, by year")

# Production of ingredient, 10 time periods, Units, chart
convChildT10 %>%
  select(inventorytype, Units=childweight, G =child_usableweight, t=rowN, conversions) %>%
  mutate(KG=G/1e3) %>%
  filter(inventorytype%in%ingrdnts,
         t<10,
         conversions>1) %>%
  select(-G) %>%
  arrange(-KG) %>%
  ggplot(aes(x=t, y=Units, color=inventorytype)) + geom_line() +
  labs(title="Number of Conversions by Ingredient",
       y="Units Produced")

# No Longer Need:
# Table ingredient production, all-time (units, KG)
convChild %>%
  select(inventorytype, Units=childwt, G =childusablewt) %>%
  mutate(KG=G/1e3) %>% 
  filter(inventorytype%in%ingrdnts) %>%
  select(-G) %>%
  arrange(-KG) %>%
  knitr::kable(caption="Ingredient Production. Repeat this analysis for separate years?")

  
```

#### Retail Flower

```{r}
retailFlower <- c("Usable Marijuana", "Marijuana Mix")

# Production of ingredient, 3 time periods, KG, table
convChildT %>%
  select(inventorytype, Units=childweight, G =child_usableweight, t=range) %>%
  mutate(KG=G/1e3) %>%
  filter(inventorytype%in%retailFlower) %>%
  select(-G) %>%
  arrange(-KG) %>%
  select(inventorytype, KG, t) %>%
  spread(t, KG) %>%
  arrange(-`3`) %>%
  kable(digits=1, caption='Production of "Flower" Types by year (KG)')

convChildT %>%
  select(inventorytype, Units=childweight, G =child_usableweight, t=range) %>%
  mutate(UnitsK=Units/1e3) %>%
  filter(inventorytype%in%retailFlower) %>%
  select(inventorytype, Units, t) %>%
  spread(t, Units) %>%
  arrange(-`3`) %>%
  kable(digits=1, caption='Production of "Flower" Types by year (Units)')

# Production of ingredient, 10 time periods, Units, chart
convChildT10 %>%
  select(inventorytype, Units=childweight, G =child_usableweight, t=rowN, conversions) %>%
  mutate(MT=G/1e6) %>%
  filter(inventorytype%in%retailFlower,
         t<10,
         conversions>1) %>%
  select(-G) %>%
  arrange(-MT) %>%
  ggplot(aes(x=t, y=MT, color=inventorytype)) + geom_line() +
  labs(title="Number of Conversions, Retail Flower",
       y="MT Produced")

# Production of ingredient, 10 time periods, Units, chart
convChildT10 %>%
  select(inventorytype, Units=childweight, G =child_usableweight, t=rowN, conversions) %>%
  mutate(MT=G/1e6) %>%
  filter(inventorytype%in%retailFlower,
         t<10,
         conversions>1) %>%
  select(-G) %>%
  arrange(-MT) %>%
  ggplot(aes(x=t, y=Units/1e3, color=inventorytype)) + geom_line() +
  labs(title="Number of Conversions, Retail Flower",
       y="1000 Units Produced")

# CHART ALL-TIME (Turned off)
# convChild %>%
#   select(inventorytype, Units=childwt, G =childusablewt) %>%
#   mutate(MT=G/1e6) %>% 
#   filter(inventorytype%in%retailFlower) %>%
#   select(-G) %>%
#   arrange(-MT) %>%
#   knitr::kable(caption='Ingredient Production of "Flower" Types -Repeat for separate years?', digits=1)
```

#### Retail, Non-Flower

```{r}
retailOther <- c("Solid Marijuana Infused Edible",
                 "Liquid Marijuana Infused Edible",
                 "Marijuana Extract for Inhalation",
                 "Marijuana Mix Infused",
                 "Capsule",
                 "Marijuana Infused Topicals",
                 "Tincture",
                 "Suppository")

# Production of ingredient, 3 time periods, KG, table
convChildT %>%
  select(inventorytype, Units=childweight, G =child_usableweight, t=range) %>%
  mutate(KG=G/1e3) %>%
  filter(inventorytype%in%retailOther) %>%
  select(-G) %>%
  arrange(-KG) %>%
  select(inventorytype, KG, t) %>%
  spread(t, KG) %>%
  arrange(-`3`) %>%
  kable(digits=1, caption='Production of Non-Flower Retail (KG)')

# Production of ingredient, 10 time periods, Units, chart
convChildT %>%
  select(inventorytype, Units=childweight, G =child_usableweight, t=range) %>%
  mutate(UnitsK=Units/1e3) %>%
  filter(inventorytype%in%retailOther) %>%
  select(-G) %>%
  arrange(-UnitsK) %>%
  select(inventorytype, t, UnitsK) %>%
  spread(t, UnitsK) %>%
  arrange(-`3`) %>%
  kable(digits=1, caption='Production of Non-Flower Retail (KG)')

# Production of ingredient, 10 time periods, Units, chart
convChildT10 %>%
  select(inventorytype, Units=childweight, G =child_usableweight, t=rowN, conversions) %>%
  mutate(MT=G/1e6) %>%
  filter(inventorytype%in%retailOther,
         t<10,
         conversions>1) %>%
  select(-G) %>%
  arrange(-MT) %>%
  ggplot(aes(x=t, y=Units/1e3, color=inventorytype)) + geom_line() +
  labs(title="Production of Non-Flower Retail",
       y="Units Produced (1000s)")

# 
```

### 4C THC/CBD Concentrations

#### "Ingredients"


```{r}
potencyAnnual <- read_csv("../data/thccbdannual.csv")

# Display THC
potencyAnnual %>% 
  select(-TotalCBD) %>%
  filter(invtype %in% ingrdnts) %>%
  spread(invtype, TotalTHC) %>%
  kable(digits=1, caption='Ingredient Average THC Concentrations, by Year')

# Display CBD
potencyAnnual %>% 
  select(-TotalTHC) %>%
  filter(invtype %in% ingrdnts,
         test_year%in%2016:2017) %>%
  spread(invtype, TotalCBD) %>%
  kable(digits=2, caption='Average CBD %s')

```

```{r getIngredientTHCMT}

```

#### Retail Products

```{r}
# Estimate kgTHC for retail products (TotalTHC % * KG)
convChild %>%
  filter(inventorytype%in%retailOther) %>%
  select(inventorytype, Units=childwt, G=childusablewt) %>%
  left_join(potencyAnnual %>%
               filter(test_year==2017) %>% select(-test_year),
             by=c('inventorytype'='invtype')) %>%
  mutate(kgTHC = G * TotalTHC / 1e6,
         kgCBD = G * TotalCBD / 1e6) %>%
  mutate(KG = G / 1e3,
         UnitsK = Units /1e3) %>% 
  ungroup %>%
  select(inventorytype, UnitsK, KG, THC=TotalTHC, CBD=TotalCBD, kgTHC, kgCBD) %>%
  arrange(-UnitsK) %>%
  kable(digits=1, caption="Retail Products: THC/CBD Concentrations and Weights")
  
  
```

### 4D. Farmgate revenue (by producer/processor good)

#### Plants/Harvest/Lotted Material (Producers)

This contains non-processed inputs.

#### TODO: add transfers divided by 3 time points for rows in tables?

```{r}
plants <- c("Seed", "Plant Tissue", "Mature Plant", "Clone", "Wet Flower")
lots <- c("Flower Lot", "Other Plant Material Lot")

# Import inventorytransfers with 10 time points cut by ID
transfersT10 <- read.csv("../gqoutput/results-20180913-171901.csv") %>%
  mutate(inventorytype = getInvtype(inventorytype),
         pricePerG = kUSD/kg,
         unitsK=units/1e3,
         perPerUnit = kUSD/unitsK) %>%
  filter( t < max(t))

transferT10Max <- max(transfersT10$t)

transfers %>%
  filter(invtype %in% c(plants, lots)) %>% 
  arrange(-nTransfers) %>% select(-usableweight) %>% kable(digits=2)

transfersT10 %>%
  filter(inventorytype %in%c(plants, lots)) %>%
  select(kUSD, t, inventorytype) %>%
  spread(inventorytype, kUSD) %>%
  kable(caption="$1000 sales", digits=1)

transfersT10 %>%
  filter(inventorytype %in%c(plants, lots)) %>%
  select(units, t, inventorytype) %>%
  spread(inventorytype, units) %>%
  kable(caption="1000 units", digits=1)

transfersT10 %>%
  filter(inventorytype %in%c(plants, lots)) %>%
  select(kg, t, inventorytype) %>%
  spread(inventorytype, kg) %>%
  kable(caption="kg", digits=1)

transfersT10 %>%
  filter(inventorytype %in%c(plants, lots)) %>%
  ggplot(aes(x=t, y=units/1e3, color=inventorytype)) + geom_line() +
  labs(title="Plant and Lot Sales by Units (1000)")

transfersT10 %>%
  filter(inventorytype %in%c(plants, lots)) %>%
  ggplot(aes(x=t, y=kUSD, color=inventorytype)) + geom_line() +
  labs(title="Plant and Lot Sales by $1000s")
```

#### "Ingredients" (Processors)

This contains procesed inputs

```{r}
transfers %>%
  filter(invtype %in% ingrdnts) %>% arrange(-nTransfers) %>% select(-usableweight) %>% kable(digits=2)

transfersT10 %>%
  filter(inventorytype %in%ingrdnts) %>%
  select(kUSD, t, inventorytype) %>%
  spread(inventorytype, kUSD) %>%
  kable(caption="$1000 sales", digits=1)

transfersT10 %>%
  filter(inventorytype %in%ingrdnts) %>%
  select(units, t, inventorytype) %>%
  spread(inventorytype, units) %>%
  kable(caption="1000 units", digits=1)

transfersT10 %>%
  filter(inventorytype %in%ingrdnts) %>%
  select(kg, t, inventorytype) %>%
  spread(inventorytype, kg) %>%
  kable(caption="kg", digits=1)

transfersT10 %>%
  filter(inventorytype %in%ingrdnts) %>%
  ggplot(aes(x=t, y=units/1e3, color=inventorytype)) + geom_line() +
  labs(title="Ingredient Sales by Units (1000)")

transfersT10 %>%
  filter(inventorytype %in%ingrdnts) %>%
  ggplot(aes(x=t, y=kUSD, color=inventorytype)) + geom_line() +
  labs(title="Ingredient Sales by $1000s")

```

#### Retail Products

This examines only retail products.

```{r}
transfers %>%
  filter(invtype %in% c(retailFlower, retailOther)) %>% 
  mutate(pricePerG = saleprice/usableweight) %>%
  arrange(-nTransfers) %>% kable(digits=2)
```

```{r, fig.width=10}
transfers %>%
  filter(invtype %in% c(retailFlower, retailOther)) %>% 
  mutate(pricePerG = saleprice/usableweight) %>%
  arrange(-saleprice) %>% kable(digits=2)


transfersT10 %>%
  filter(inventorytype %in% c(retailFlower, retailOther)) %>%
  arrange(-units) %>%
  select(t, inventorytype, unitsK) %>%
  spread(inventorytype, unitsK)%>% 
  kable(digits=2, caption='1000 units')

transfersT10 %>%
  filter(inventorytype %in% c(retailFlower, retailOther)) %>%
  arrange(-kUSD) %>%
  select(t, inventorytype, kUSD) %>%
  spread(inventorytype, kUSD)%>% 
  kable(digits=2)

transfersT10 %>%
  filter(inventorytype %in% c(retailFlower, retailOther)) %>%
  gather(metric, value, units, kg, kUSD, pricePerG) %>%
  filter(metric!='kg') %>%
  ggplot(aes(x=t, y=value, color=inventorytype)) + geom_line() +
  facet_wrap(~metric, scales='free') +
  labs(title="Retail Production: $, Units, Price-per-kg-usableweight")
  
```


### 4E. Retail Products

#### 4Ei: Sales: (Units, $) - by product type

##### Sales Volume (Units)

```{r, echo=FALSE}
# TODO: Update query for proper unit/item-transaction definition
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=itemtransactions, color=invtype)) + geom_line() +
  labs(title="Retail Item-Transactions by Inventory Type",
       y="Item-transactions (retail data rows)",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")


# Table - monthly
# retailUSDxType %>%
#   select(invtype, date, itemtransactions) %>%
#   spread(invtype, itemtransactions) %>%
#   knitr::kable(caption='Retail Item-Transactions By Inventory Type', digits=0)

# Table - annual
retailUSDxType %>%
  group_by(YEAR, invtype) %>%
  summarise(itemtransactions = sum(itemtransactions, na.rm=T)) %>%
  select(invtype, YEAR, itemtransactions) %>%
  spread(invtype, itemtransactions) %>%
  knitr::kable(caption='Retail Item-Transactions By Inventory Type - Annual', digits=0)

```

##### Sales Volume (Dollars)

```{r, echo=FALSE}
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=price_x, color=invtype)) + geom_line() +
  labs(title="Gross Retail Sales by Inventory Type",
       y="$1000, Post-Excise",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months") +
  scale_y_continuous(labels=scales::dollar_format())


# Table
# retailUSDxType %>%
#   select(invtype, date, price_x) %>%
#   spread(invtype, price_x) %>%
#   knitr::kable(caption='Post-Excise Tax Sales By Inventory Type ($1k)', digits=0)


# Table - annual
retailUSDxType %>%
  group_by(YEAR, invtype) %>%
  summarise(price_x = sum(price_x)) %>%
  select(invtype, YEAR, price_x) %>%
  spread(invtype, price_x) %>%
  knitr::kable(caption='Post-Excise Tax Sales By Inventory Type ($1k) - Annual', digits=0)

```


#### 4Eii:THC/CBD Content

```{r, echo=FALSE}
# TODO: Update query for weighted averages
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=totalTHC, color=invtype)) + geom_line() +
  labs(title="THC Content by Inventory Type",
       y="THC Percent",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")


# Table
# retailUSDxType %>%
#   select(invtype, date, totalTHC) %>%
#   spread(invtype, totalTHC) %>%
#   knitr::kable(caption='Mean THC Content By Inventory Type', digits=0)

retailUSDxType %>%
  group_by(YEAR, invtype) %>%
  summarise(totalTHC = weighted.mean(totalTHC, price_x)) %>%
  select(invtype, YEAR, totalTHC) %>%
  spread(invtype, totalTHC) %>%
  knitr::kable(caption='Mean THC Content By Inventory Type (Weighted by $ Sales) - Annual', digits=1)

```


```{r, echo=FALSE}
# TODO: Update query for weighted averages
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=totalCBD, color=invtype)) + geom_line() +
  labs(title="CBD Content by Inventory Type",
       y="CBD Percent",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")


# Table
# retailUSDxType %>%
#   select(invtype, date, totalCBD) %>%
#   spread(invtype, totalCBD) %>%
#   knitr::kable(caption='Mean CBD Content By Inventory Type', digits=0)

retailUSDxType %>%
  group_by(YEAR, invtype) %>%
  summarise(totalCBD = weighted.mean(totalCBD, price_x)) %>%
  select(invtype, YEAR, totalCBD) %>%
  spread(invtype, totalCBD) %>%
  knitr::kable(caption='Mean CBD Content By Inventory Type (Weighted by $ Sales) - Annual', digits=1)

```

### 4F. Supply Chain Dynamics: Product Flows and Conversion Ratios

##### 4Fi.	Efficiency: Flower/OPM-per-ingredient (gram-to-gram ratio). Conversion Ratios (inventoryconversions)

This data needs substantial cleaning (top-censoring the parent and child weights; allowing usablewt to be interpretable by performing the correct wt*usableweight calculations (perhaps also requiring top-coding or some other conditional logic to prevent absurd values)) before it can be interpretable.

```{r}
# TODO: clean childusableweight when it an childwt is present.
ratiosRaw <- convDetailed %>%
  group_by(parent, child) %>%
  summarise(conversions = sum(nConversions),
            ratiowt2wt = sum(parentwt, na.rm=T)/sum(childwt, na.rm=T),
            ratiowt2uwt = sum(parentwt, na.rm=T)/sum(childusablewt, na.rm=T),
            ttlparentwt = sum(parentwt, na.rm=T),
            ttlchildwt = sum(childwt, na.rm=T),
            ttlchilduwt = sum(childusablewt, na.rm=T),
            # ttlchildwtXuwt = sum(childwt*childusablewt, na.rm=T),
            ratiowt2wtXuwt = sum(parentwt, na.rm=T)/sum(childusablewt * childwt, na.rm=T)
            ) %>%
  arrange(-conversions)

kable(ratiosRaw, digits=2)
```

###### (wet?) Flower / OPM – to –  ingredient… (Hydrocarbon wax; CO2 Hash Oil;  Food Grade Solvent Extract)...

###### Flower / OPM – to – final product (Extract, Solid / Liquid Edible, etc.)



##### 4Fii. End products as share of canopy:

#### Conversion Pathway Prevalence

The table below produces a simple count of the number of records in each.

```{r}
convPaths %>% head(50) %>% kable(caption="Dominant Conversion Pathways")
```

[[ compute pathway prevalence in percentage terms, a la Markov chain, and put results here ]]


###### Retail products by % of flower/OPM production (by weight)

###### by % of “all” production


### Licensee Revenue Analysis

#### Producer/P&P/Processors

This can be generated from inventorytransfers table. inventorytransfer::saleprice. Validate/verify this. (5.3mil records)


```{r}
# GoogleQuery: ?????

# Aggregate revenues for all producers.

```

#### Stores

This can be generated from the dispensing table.


### Harvest

[[ Results will go here ]]  
[[ kg harvest of wet flower, dry flower, OPM, and waste]] 

And the 5 most popular child products (data needs cleaning):

```{r}
convDetailed %>%
  filter(!child %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"),
         !child %in% c("Usable Marijuana")) %>%
  group_by(child) %>%
  summarise(nConversions = sum(nConversions),
           childwt = sum(childwt, na.rm=T),
           childusablewt = sum(childusablewt, na.rm=T)) %>%
  arrange(-childwt) %>%
  head(5) %>%
  kable(caption='inventoryconversion children')
```

Though it is less interesting, we can also tabulate data by parent type. This can be used to validate.

 
```{r, eval = F, include=F}
# Queries


# QUERY: Get weight of harvested material. This crashes Google Query.
SELECT location, plantid, MIN(sessiontime) AS firstharvest,
SUM(CASE WHEN inventorytype = 29 THEN dweight else 0 END) as wet_weight,
SUM(CASE WHEN inventorytype = 6 THEN dweight else 0 END) as dry_weight,
SUM(CASE WHEN inventorytype = 9 THEN dweight else 0 END) as opm_weight
FROM [rand-systems:full_WA_data__proper.biotrackthc_plantderivatives]
-- remove deleted records
WHERE deleted = 0
GROUP BY location, plantid, inventorytype;

# SIMPLER (Crash-proof?): Get weight of harvested material.
SELECT location,
SUM(CASE WHEN inventorytype = 29 THEN dweight else 0 END) as wet_weight,
SUM(CASE WHEN inventorytype = 6 THEN dweight else 0 END) as dry_weight,
SUM(CASE WHEN inventorytype = 9 THEN dweight else 0 END) as opm_weight
FROM [rand-systems:full_WA_data__proper.biotrackthc_plantderivatives]
-- remove deleted records
WHERE deleted = 0
GROUP BY location, inventorytype;

# RUN THIS QUERY

# This query is saved in the table: plant_stats_distinct_location
# select a.location AS location, b.locationtype AS locationtype, a.plantid AS plantid,
# a.sessiontime AS sessiontime, a.wet_weight AS wet_weight, a.dry_weight AS dry_weight,
# a.opm_weight AS opm_weight
# from [rand-systems:TEAM_WORKSPACE_USE_ME.plant_stats_distinct] a
# JOIN (
# select id, locationtype
# FROM
# [rand-systems:full_WA_data__proper.biotrackthc_locations]) b ON a.location =b.id
# WHERE b.locationtype < 7;
```

#### Production Volumes

### Processing / Manufacturing

This sub-section includes: 1) production volumes, 2) pathway prevalence, 3) conversion ratios



## Notes on workflow / tables

### plantderivatives (Harvest Events)

The "plantderivatives" table records the harvesting from plants of dry flower, wet flower, other plant material, and waste. Aggregations are calculated by adding **dweight** after cleaning, top-censored based on harvest-per-plant (at 1.5kg each **?**). **dwholeweight** records the entire harvest weight across many plants; **dweight** apportions an equal fraction of this across all plants harvested. 

**Notes**

+ inventory::waste record count: 989,387 
+ sum(inventory::waste[inventorytype==26]) > 600mil kg (assuming units = gram)
+ Almost all dry flower has inventoryid. Many plants have a wet weight but no dry weight, e.g. 250,000 plants in November 2017 due to end of traceability reporting.


### inventorycombinations (Lotting Events)

The "inventorycombinations" table records the combination of individual raw production units to aggregate lots.  The input types to this process are Dry Flower (inventorytype 6) and Other Plant Material (9). Lotted units include Flower lot (13), OPM lot (14), and marijuana mix (30). I speculate that inventorycombinations is essentially inventoryconversions but for same-type converrsions (e.g. flower lot - flower lot), as most entries have an NA parent-type and only an inventorytype for children. There are a few entries with different-type conversions, but these are likely errors.

TODOs

+ Verify understanding that table captures all same-type conversions (i.e. combinations), and this explains why often oldtype = NA.
+ Data cleaning: Quantities of the parent ("parent_difference") and child ("childweight", "child_usableweight"). Top-censor values, e.g., at 99%ile by parent/child inventorytype.
+ very regulations to verify max parent lot sizes (5kg flower lot /10kg OPM lost).

```{r}
# TODO: after parsing SESSIONTIME, add year-month to query.
# Query (lotQuery): simple count of lots
# -- Count the number of lots made (by input/output type) over time, statewide
# SELECT OLDTYPE, NEWTYPE, count(*) as numlots
# FROM [full_WA_data__proper.biotrackthc_inventorycombinations]
# GROUP BY oldtype, newtype

lots <- read_csv("../gqoutput/results-20180630-122340.csv") %>%
  mutate(OLDTYPE = getInvtype(OLDTYPE),
         NEWTYPE = getInvtype(NEWTYPE)
         )
knitr::kable(lots, caption="Lot counts by input-output type")
```

### inventorytransfers (Wholesale Transactions)

This table records all licensee-to-licensee transactions, including a **price** but not date. This table cannot be instantly enriched with THC data, but perhaps could if additional merging is performed as to link inventoryids with inventoryparentids.


### inventoryconversions (Processing and Manufacturing)

The inventory conversions table records all conversions from one inventory type to another. This is key. This table is tagged with (allowing **time-series**) and **licensee-level** data (manufacturer of the child product), so complex analysis is possible. By merging on inventoryid, products downstream of testing can also have **THC** contents estimated. By merging with the table inventorytransfers, we ought to be able to compute all **revenue** figures too. Data span nearly the entire supply chain:

+ Lotting stage (flower -> flower lot)
+ processing/manufacturing stage 1 (flower/OPM to intermediate extracts)
+ processing/manufacturing stage 1 (intermediate extracts to retail product)

This table gets the finest grain of stuff (licensee x parent-type x child-type). Should also add date once we know how to parse that.

**Available information in this table**  
date, location, parentweight (always grams?), childweight, childusableweight.


TODOs:

+ Add this table to the new Google Query schema ("...proper")
+ clean childusableweight when it an childwt is present. it seems like we sometimes but not always have to multiply wt * usablewt. Until we do that, the ratios will be wrong. 
+ Enrich inventoryconversions table with **THC** (merge on inventoryid with lab table, for eligible products).
+ Since data is tagged only with creator license, but since it seems like this table captures all conversion pathways, many products are re-appearing in this table several times. So, attempt to create a new table that wouldu use a recursive merge to analyze with to/from licensee data? (e.g. for network analysis)

Below we produce a preview of the data in this table. (Date is also available but not shown here.)

```{r}
kable(convDetailed %>% 
        sample_n(5))
```

This table can be viewed with respect to parent or child products. Parent products include lots and all intermediate products. Child products include all intermediate products and retail products.  

Below we show the five most popular parent products (data needs cleaning):


```{r}
convDetailed %>%
  filter(!parent %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"),
         !parent %in% c("Usable Marijuana")) %>%
  group_by(parent) %>%
  summarise(nConversions = sum(nConversions),
           parentwt = sum(parentwt, na.rm=T)) %>%
  arrange(-parentwt) %>%
  head(5) %>%
  kable(caption='inventoryconversion parents')
```

## Validation

Here are miscellaneous tables.

### Audit harvest v lots v conversion-parents

Lots are produced in the inventorycombinations table (from dry flower or OPM), before they then re-appear in the inventoryconversions table for conversions to other products. Therefore we can use these two tables (after cleaning) to validate the data. We will triangulate this from various tables:

+ inventorycombinations - lotting
+ inventoryconversions - parent product
+ inventoryconversions - child product

```{r}
lots %>% 
  group_by(NEWTYPE) %>%
  summarise(numlots = sum(numlots)) %>%
  kable(caption="Number of lots from inventorycombinations")
```

```{r}
convDetailed %>%
  filter(parent %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot")) %>%
  group_by(parent) %>%
  summarise(nConversions = sum(nConversions),
           parentwt = sum(parentwt, na.rm=T)) %>%
  arrange(-parentwt) %>%
  kable(caption='number of lots used as parent in inventoryconversions')
```

```{r}
convDetailed %>%
  filter(child %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot")) %>%
  group_by(child) %>%
  summarise(nConversions = sum(nConversions),
           childwt = sum(childwt, na.rm=T),
           childusablewt = sum(childusablewt, na.rm=T)) %>%
  arrange(-childwt) %>%
  kable(caption='number of lots used as child in inventoryconversions')
```

Though it is less interesting, we can also tabulate data by parent type. This can be used to validate.

### Validate Conversion-parents

This is not intrinsically interesting but could be used to validate harvest/lotting data. Note an average conversion-weight of almost 5000 (5kg?) for flower and 10,000 (10kg?) for OPM.

```{r}
knitr::kable(convParent, digits=1)
```