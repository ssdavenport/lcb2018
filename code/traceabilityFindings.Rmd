---
<<<<<<< HEAD
title: "Traceability-Based Findings v 1.3"
=======
title: "Traceability-Based Findings"
>>>>>>> 394a1ae9cfc5ae43d746cd0ca1b9f0ef4d3737f2
author: "Steven Davenport"
date: "`r format(Sys.time(), '%B %d, %Y (%H:%M)')`"
output: html_document
---

<<<<<<< HEAD
This document consolidates findings related to the WA traceability data. Queries are performed in Google Query, for export to CSVs that are loaded and cleaned in this script for display/plotting. This is intended to be an interative document.

Note: you can search-replace this document for "UNKNOWN" to find areas where we need clarification on tables.  

**Progress to Date**

v1.3 (June 30) restructured outline.  
v1.2 (June 30) added analysis of inventoryconversions table.  
v1.1 (June 29) clarified outline; incorporated comments from Kee Won RE methods. Was sent briefly to JPC.  
v1.0 (June 27) provided outline; finished first draft of retail tables.

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      # Graphic output
                      fig.width = 8, fig.align='center')
library(tidyverse)
library(knitr)
source("functions.r")
#TODO: write function to turn inventorytype to invtype
=======
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
>>>>>>> 394a1ae9cfc5ae43d746cd0ca1b9f0ef4d3737f2
```

```{r, echo=FALSE}
make_date <- function(yyyy, m, quarter=F) {
  # we need this for negative substring indexing
  require(stringr)
  # year is 4 digits; month is either 1 or 2 digits.
  # Correct month by prefixing 0, getting all but last digit
  month <- str_sub(paste0(0, m), -2) 
  
  as.Date(paste0(yyyy, "-", month, "-01"))
}
```

<<<<<<< HEAD
## Report Outline

+ Producer-Level (i.e. Farm-Gate / Primary Products)
  + **New dichotomy: 1) harvest, 2) lot?**
  + Raw Production (Harvest, Flower (dry/wet) and Other Plant Material)
    + Gross weight
    + Revenues **?**
    + THC Content
  + Harvest-Stage Waste/Discards
  + Lot Production (Flower Lot, OPM Lot)
    + Gross weight
    + Revenues
    + THC Content
  + *NOTE: does Usable Marijuana go here or below?*
+ Processor-Level (Post-Harvest)
  + Secondary Production (e.g. BHO, ...)
    + Gross weight
    + Unit counts
    + Revenues
  + Waste/Discards (Processing/Inventory stage)
    + *NOTE: What are processes here?*
  + Conversion Ratios (grams-to-grams / grams-to-units)
    + Flower to concentrate (intermediate or final products)
    + Other Plant Material to concentrate (intermediate or final products)
+ Retail-Level
  + Sales volume by retail product type (Units, $):
    + Usable Marijuana; Marijuana Mix Infused; Marijuna Mix Package; etc.
  + THC Content and trends
    + Usable Marijuana; Marijuana Mix Infused; Marijuna Mix Package; etc.
+ Licensee-level (table: inventorytransfers; requesting date field from LCB)
  + Revenues by License Class: Producer; P/P; Processor/ Retailer

## Method Outline

+ Gross weight(g)/unit-counts
  + Available for all post-harvest supply chain (lotting, intermediate manufacturing, final-stage manufacturing); available over time, by licensee. (table: inventoryconversions)
+ Waste/discards
  + tricky. plant table. **Kee Won**
+ Conversion ratios
  + Available over time, by licensee. (table: inventoryconversions).
+ Revenues
  + Available by licensee (table:inventorytransfers); available over time pending data request
+ THC content ?
  + Available at retail, with trickiness for some products (table: dispensing)
  
## To Dos

### Questions for Beau 

+ Which "conversion ratios" do we care about? Flower to end product and OPM to end product?
+ Define resolution of retail product analysis. Shuold we consolidate the minor retail product types, e.g. capsule / suppository? Should we collapse similar products e.g. usable marijuana and marijuana mix package?

### Data Prep/Cleaning

+ Check if inventorytransfers can be used to merge price onto conversions.
  + I think not. because inventoryIDs will be different.
+ Prepare labresults (in googlequery) table to allow merge on inventoryconversions
  + might not work because no inventoryparentid in inventoryconversions
+ Enrich inventoryconversions table with **THC** (merge on inventoryid with lab table, for eligible products).
+ Enrich inventoryconvetsions table with **wholesale-price** (merge on inventoryid with inventorytransactions; might require an extra step / recursive merge to link the inventoryID to the transactionID.)
+ Upload inventorycombinations table to new googlequery schema, converting fields to integer.

#### Inventory Conversions

+ analytical/conceptual
  + Determine analytical framework for this analysis. Calculate percentages respective to the input or the output type? Change-over-time analysis? What policy question can this answer? **JPC**?
  + Generate a Lorenz curve / HHI for each parent/child product type? Perhaps separate for each year? This can let us analyze 
  + Make Markov-type matrix of conversion pathways?
+ data/technical
  + Re-run this with the full_WA_data_proper table?
  + Verify: location/orgid refers to the manufacturer of the end product
  + Since data is tagged only with creator license, but since it seems like this table captures all conversion pathways, many products are re-appearing in this table several times. So, attempt to 
  create a new table that would sort of compute a recursive merge to analyze with to/from licensee data?
+ Parents
  + check regulations to verify max parent lot sizes (5kg/10kg).
  + consider data cleaning to remove lot sizes over certain #?
+ Children
  + ?
+ Conversion ratios
  + clean childusableweight when it an childwt is present. it seems like we sometimes but not always have to multiply wt * usablewt. Until we do that, the ratios will be wrong. 
** KEE WON**

#### Lab Results

+ Clean THC data (some are >100)


### Misc

**Later To Do's**


+ Define resolution of the secondary processing analysis (likewise). Should rare intermediate products be collapsed or excluded?

## Load Tables from Google Query

Here we will load top-level tables from GoogleQuery. They will be pulled upon from other sections of the report. Maybe also preview the raw tables (just a few rows).


## Data Analysis

Sections here are not provided according to the report outline. Rather they are provided in a sequence/grouping relating to how they are pulled from the data. Therefore the structure is a bit different.

### Harvest Events (plantderivatives)

table: plantderivatives.  

if you harvest 10 plants at once, then you get **dwholeweight**. a proportion amount is assigned to each plant harvest -> **dweight**. So forget about dwholeweight.

Almost all dry flower has inventoryid. Many plants have a wet weight but no dry weight, e.g. 250,000 plants in November 2017 due to end of traceability reporting.

Join: plantderivatives::inventoryid - inventoryid::labresults_samples. Might not work.  

table: plantderivatives. Contains harvest events. INVENTORYTYPE shows the type of material harvested. Plants are harvested into wet material (29), other plant material (9), and dry material (6). (WASTE???) DWEIGHT shows weight of the harvested material. DWHOLEWEIGHT means **UNKNOWN**.

TODO: Diagnose.

make a destination table to hold results. limit_10. bigquery -> show options. allow large results.
```{r, eval = F, include=F}
# Queries


# QUERY: Get weight of harvested material. This crashes Google Query.
SELECT location, plantid, MIN(sessiontime) AS firstharvest,
SUM(CASE WHEN inventorytype = 29 THEN dweight else 0 END) as wet_weight,
SUM(CASE WHEN inventorytype = 6 THEN dweight else 0 END) as dry_weight,
SUM(CASE WHEN inventorytype = 9 THEN dweight else 0 END) as opm_weight
FROM [rand-systems:full_WA_data__proper.biotrackthc_plantderivatives]
-- remove deleted records
WHERE deleted = 0
GROUP BY location, plantid, inventorytype;

# SIMPLER (Crash-proof?): Get weight of harvested material.
SELECT location,
SUM(CASE WHEN inventorytype = 29 THEN dweight else 0 END) as wet_weight,
SUM(CASE WHEN inventorytype = 6 THEN dweight else 0 END) as dry_weight,
SUM(CASE WHEN inventorytype = 9 THEN dweight else 0 END) as opm_weight
FROM [rand-systems:full_WA_data__proper.biotrackthc_plantderivatives]
-- remove deleted records
WHERE deleted = 0
GROUP BY location, inventorytype;

# RUN THIS QUERY

# This query is saved in the table: plant_stats_distinct_location
# select a.location AS location, b.locationtype AS locationtype, a.plantid AS plantid,
# a.sessiontime AS sessiontime, a.wet_weight AS wet_weight, a.dry_weight AS dry_weight,
# a.opm_weight AS opm_weight
# from [rand-systems:TEAM_WORKSPACE_USE_ME.plant_stats_distinct] a
# JOIN (
# select id, locationtype
# FROM
# [rand-systems:full_WA_data__proper.biotrackthc_locations]) b ON a.location =b.id
# WHERE b.locationtype < 7;
```

#### Wet Flower / OPM

#### Waste

table: "inventoryderivatives". Waste from harvesting.
inventory::waste record count: 989,387 
sum(inventory::waste[inventorytype==26]) > 600mil kg (assuming units = gram)

table: plantderivatives. (what stage is this?)
Requires substantial data cleaning. Simple sums give crazy numbers.
Maybe also more post-harvest waste in other inventorytables.


### Lotting Events (inventorycombinations)

The "inventorycombinations" table records the combination of individual raw production units to aggregate lots.  The input types to this process are Flower (inventorytype 6) and Other Plant Material (9). Lotted units include Flower lot (13), OPM lot (14), and marijuana mix (30).





#### Volume: counts

TODO: Validate this hypothesis: Inventorycombinations is for same-type conversions (e.g. flower lot - flower lot) but has been misused by certain licensees, probably early on in WA's market; inventoryconversions is for different-type conversions. This would explain why inventorycombinations generally (but now always) has NA types for oldtype/parenttype.

TODO: Ask LCB/Comment on why oldtype = NA (created from nothing?)
TODO: Consider ditching this entirely in favor of inventoryconversions table.

```{r}
# TODO: after parsing SESSIONTIME, add year-month to query.
# Query (lotQuery): simple count of lots
# -- Count the number of lots made (by input/output type) over time, statewide
# SELECT OLDTYPE, NEWTYPE, count(*) as numlots
# FROM [full_WA_data__proper.biotrackthc_inventorycombinations]
# GROUP BY oldtype, newtype
lots <- read_csv("../gqoutput/results-20180630-122340.csv") %>%
  mutate(OLDTYPE = getInvtype(OLDTYPE),
         NEWTYPE = getInvtype(NEWTYPE)
         )
knitr::kable(lots, caption="Lot counts by input-output type")
```

### Production Weight (inventoryconversions)

The inventory conversions table records all conversions from one inventory type to another. This is key. This table is tagged with (allowing **time-series**) and **licensee-level** data (manufacturer of the child product), so complex analysis is possible. By merging on inventoryid, products downstream of testing can also have **THC** contents estimated. By merging with the table inventorytransfers, we ought to be able to compute all **revenue** figures too. Data span nearly the entire supply chain:

+ Lotting stage (flower -> flower lot)
+ processing/manufacturing stage 1 (flower/OPM to intermediate extracts)
+ processing/manufacturing stage 1 (intermediate extracts to retail product)

**Available information in this table**  
date, location, parentweight (always grams?), childweight, childusableweight.

Example of the data in this table. (could also add date)

```{r}
# -- QUERY
#  SELECT inventorytype, inventorytype_parent, location,
#    count(*) as nConversions,
#    sum(CAST(parent_difference as integer)) as parentwt,
#    sum(CAST(childweight as integer)) as childwt,
#    sum(CAST(child_usableweight as integer)) as childusablewt
# FROM [full_WA_data.biotrackthc_inventoryconversions]
# GROUP BY inventorytype, inventorytype_parent, location

convDetailed <- read_csv("../gqoutput/results-20180630-133936.csv") %>%
  mutate(parent = getInvtype(inventorytype_parent),
         child = getInvtype(inventorytype))  %>%
  select(-inventorytype_parent, -inventorytype) %>%
  arrange(-nConversions)

kable(convDetailed %>% head(8))

# TODO: Add licensee name, date
write.csv(convDetailed, "../output/conversionsDetailed.csv")

```



This table gets the finest grain of stuff (licensee x parent-type x child-type). Should also add date once we know how to parse that.


#### Table structure

##### Parent analysis (input)

Count number of conversions by parent; calculate gross totals (weight) of parent products. At this stage (considering the parent inventorytypes), I think weight = usableweight (grams). Note an average conversion-weight of almost 5000 (5kg?) for flower and 10,000 (10kg?) for OPM.

```{r}
convParent <- read_csv("../gqoutput/results-20180630-130516.csv") %>%
  mutate(inventorytype_parent = getInvtype(inventorytype_parent)) %>%
  mutate(wtPerConv = parentwt/nConversions) %>%
  arrange(-parentwt)
# -- QUERY
# SELECT inventorytype_parent,
#   count(*) as nConversions,
#   sum(CAST(parent_difference as integer)) as parentwt
# FROM [full_WA_data.biotrackthc_inventoryconversions]
# GROUP BY inventorytype_parent

knitr::kable(convParent, digits=1)
```


##### Child analysis (output)


```{r}
convChild <- read_csv("../gqoutput/results-20180630-131250.csv") %>%
  mutate(inventorytype = getInvtype(inventorytype),
         wtPer = childwt/nConversions,
         usablewtPer = childusablewt/nConversions)  %>%
  arrange(-childwt)
# -- QUERY: CHILD WEIGHTS.
#  SELECT inventorytype,
#    count(*) as nConversions,
#    sum(CAST(childweight as integer)) as childwt,
#    sum(CAST(child_usableweight as integer)) as childusablewt
# FROM [full_WA_data.biotrackthc_inventoryconversions]
# GROUP BY inventorytype

knitr::kable(convChild, digits=0)
```

##### Path Analysis (parent->child)

The table below produces a simple count of the number of records in each.

```{r}
convPaths <- read_csv("../gqoutput/results-20180630-124915.csv") %>%
  mutate(parent = getInvtype(inventorytype_parent),
         child = getInvtype(inventorytype))  %>%
  select(parent, child, nConversions) %>%
  arrange(-nConversions)
# -- Inventory Conversion parent-child
# SELECT inventorytype, inventorytype_parent, count(*) as nConversions
# FROM [full_WA_data.biotrackthc_inventoryconversions]
# GROUP BY inventorytype, inventorytype_parent
convPaths %>% head(50) %>% kable(caption="Dominant Conversion Pathways")
```

#### Output Tables

##### Flower/OPM Lots

We will triangulate this from various tables.

+ inventoryconversions - parent
+ inventoryconversions - child
+ inventorycombinations - lotting

```{r}
lots %>% 
  group_by(NEWTYPE) %>%
  summarise(numlots = sum(numlots)) %>%
  kable(caption="Number of lots from inventorycombinations")
```

```{r}
convDetailed %>%
  filter(parent %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot")) %>%
  group_by(parent) %>%
  summarise(nConversions = sum(nConversions),
           parentwt = sum(parentwt, na.rm=T)) %>%
  arrange(-parentwt) %>%
  kable(caption='number of lots used as parent in inventoryconversions')
```

```{r}
convDetailed %>%
  filter(child %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot")) %>%
  group_by(child) %>%
  summarise(nConversions = sum(nConversions),
           childwt = sum(childwt, na.rm=T),
           childusablewt = sum(childusablewt, na.rm=T)) %>%
  arrange(-childwt) %>%
  kable(caption='number of lots used as child in inventoryconversions')
```

##### Intermediate Products

```{r}
convDetailed %>%
  filter(!parent %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"),
         !parent %in% c("Usable Marijuana")) %>%
  group_by(parent) %>%
  summarise(nConversions = sum(nConversions),
           parentwt = sum(parentwt, na.rm=T)) %>%
  arrange(-parentwt) %>%
  kable(caption='inventoryconversion parents')
```

```{r}
convDetailed %>%
  filter(!child %in% c("Marijuana Mix", "Flower Lot", "Other Plant Material Lot"),
         !child %in% c("Usable Marijuana")) %>%
  group_by(child) %>%
  summarise(nConversions = sum(nConversions),
           childwt = sum(childwt, na.rm=T),
           childusablewt = sum(childusablewt, na.rm=T)) %>%
  arrange(-childwt) %>%
  kable(caption='inventoryconversion children')
```



#### Lotting
#### Intermediate Manufactures
#### Final Product




### Conversion Ratios (inventoryconversions)

This data needs substantial cleaning.

```{r}
options(scipen=99)
# TODO: clean childusableweight when it an childwt is present.
ratiosRaw <- convDetailed %>%
  group_by(parent, child) %>%
  summarise(conversions = sum(nConversions),
            ratiowt2wt = sum(parentwt, na.rm=T)/sum(childwt, na.rm=T),
            ratiowt2uwt = sum(parentwt, na.rm=T)/sum(childusablewt, na.rm=T),
            ttlparentwt = sum(parentwt, na.rm=T),
            ttlchildwt = sum(childwt, na.rm=T),
            ttlchilduwt = sum(childusablewt, na.rm=T),
            # ttlchildwtXuwt = sum(childwt*childusablewt, na.rm=T),
            ratiowt2wtXuwt = sum(parentwt, na.rm=T)/sum(childusablewt * childwt, na.rm=T)
            ) %>%
  arrange(-conversions)

kable(ratiosRaw)
```


### Retail Products

```{r, retailVolume}
# GoogleQuery: RetailUSDxType
# TODO: replace this query with the saved version? (it was lost?)

# SELECT invtype, 
# YEAR(sale_time) as YEAR,
# MONTH(sale_time) as MONTH,
# -- number of rows (item-transactions)
# count(*) as itemtransactions,
# sum(price_x) as price_x,
# -- TODO: After remaking retail view, replace with proper "TotalTHC"
# -- TODO: Replace with weighted average, w wts varied by inventorytype
# avg(thc + thca*0.877) as totalTHC,
# -- TODO: Replace this with a cleaned version of totalCBD? (
# avg(case when cbda is null then cbd
#      when cbda is not null then cbd + cbda * 0.877
#      end) as totalCBD
# 
# /*
# case when cbda is null then cbd
#      when cbda is not null then cbd + cbda * 0.877
#      end as totalCBD
# */
#       --avg(cbd + (if is not null cbda, cbda *0.877, 0)) as totalCBD
# FROM [full_WA_data__proper.Retail_ALL]
# GROUP BY invtype, YEAR, MONTH
# ORDER BY invtype, YEAR,MONTH

=======
## Outline

This document will consolidate findings related to the WA traceability data. We have been tasked to pull the following parameters/insights:

+ Producer-Level (i.e. Farm-Gate / Primary Products)
  + Production: Gross weight and THC Content **Kee Won**
    + Flower. **Dry or wet? What tables? Columns? Warnings?**
    + Other Plant Material (AKA "Shake and trim"). 
    + how do we define these? Are they wholesale or retail?
  + Revenue
    + Total revenue by licensee. (Easy.) TODO: build this query.
  + Waste and Discarded Material **Kee Won**
    + What units do we need to look at here? Tables? Harvest events?
+ Processor-Level (including Producer-Processor) **Kee Won**
  + Conversion Ratios (grams-to-grams / grams-to-units)
    + Flower to concentrate (intermediate or final products)
    + Other Plant Material to concentrate (intermediate or final products)
  + Production: Gross weight/unit-count of intermediate products **Kee Won**
    + E.g., BHO
    + Not included in project description, but may be helpful.
+ Retail-Level 
  + Sales volume by retail product type (Units, $):
    + Usable Marijuana; Marijuana Mix Infused; Marijuna Mix Package; etc.
  + Revenue (net of tax (so without excise tax?))
  + THC Content and trends
    + Usable Marijuana; Marijuana Mix Infused; Marijuna Mix Package; etc.

## Questions to answer RE approach

**Kee Won**

+ What table do we use to calculate revenue received for non-retail products? We want to use this to query producer- and processor- revenues. 
+ What table do we use to find intermediate product conversion ratios?
+ What table do we use to find amounts/ratios of discarded material?

## Findings

### Producer revenues

```{r}
# GoogleQuery: ?????

# Aggregate revenues for all producers.

```

### Retail Sales
```{r}
# GoogleQuery: RetailUSDxType
>>>>>>> 394a1ae9cfc5ae43d746cd0ca1b9f0ef4d3737f2
retailUSDxType <- read_csv("../gqoutput/results-20180627-174927.csv") %>%
  mutate(date=make_date(YEAR, MONTH)) %>%
  # Convert to $1000s
  mutate(price_x = price_x / 1e3) %>%
  filter(
    # remove NA
    !is.na(invtype),
    # remove non-retail products in here for no reason
    !invtype%in%c("Clone", "Mature Plant"),
    # Remove the partial month of October 2017
    date <= "2017-10-01")
```

<<<<<<< HEAD
#### Volume: Units, $ (x product type)

##### Sales Volume (Units)

```{r, echo=FALSE}
# TODO: Update query for proper unit/item-transaction definition
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=itemtransactions, color=invtype)) + geom_line() +
  labs(title="Retail Item-Transactions by Inventory Type",
       y="Item-transactions (retail data rows)",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")
=======
#### Sales Volume (Dollars)

```{r, echo=FALSE}
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=price_x, color=invtype)) + geom_line() +
  labs(title="Gross Retail Sales by Inventory Type",
       y="$1000, Post-Excise",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months") +
  scale_y_continuous(labels=scales::dollar_format())
>>>>>>> 394a1ae9cfc5ae43d746cd0ca1b9f0ef4d3737f2


# Table
retailUSDxType %>%
<<<<<<< HEAD
  select(invtype, date, itemtransactions) %>%
  spread(invtype, itemtransactions) %>%
  knitr::kable(caption='Retail Item-Transactions By Inventory Type', digits=0)

```

##### Sales Volume (Dollars)

```{r, echo=FALSE}
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=price_x, color=invtype)) + geom_line() +
  labs(title="Gross Retail Sales by Inventory Type",
       y="$1000, Post-Excise",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months") +
  scale_y_continuous(labels=scales::dollar_format())
=======
  select(invtype, date, price_x) %>%
  spread(invtype, price_x) %>%
  knitr::kable(caption='Post-Excise Tax Sales By Inventory Type ($1k)', digits=0)

```

#### Sales Volume (Units)

```{r, echo=FALSE}
# TODO: Update query for proper unit/item-transaction definition
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=itemtransactions, color=invtype)) + geom_line() +
  labs(title="Retail Item-Transactions by Inventory Type",
       y="Item-transactions (retail data rows)",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")
>>>>>>> 394a1ae9cfc5ae43d746cd0ca1b9f0ef4d3737f2


# Table
retailUSDxType %>%
<<<<<<< HEAD
  select(invtype, date, price_x) %>%
  spread(invtype, price_x) %>%
  knitr::kable(caption='Post-Excise Tax Sales By Inventory Type ($1k)', digits=0)
=======
  select(invtype, date, itemtransactions) %>%
  spread(invtype, itemtransactions) %>%
  knitr::kable(caption='Retail Item-Transactions By Inventory Type', digits=0)
>>>>>>> 394a1ae9cfc5ae43d746cd0ca1b9f0ef4d3737f2

```


<<<<<<< HEAD
#### THC/CBD Content
=======
#### THC Content
>>>>>>> 394a1ae9cfc5ae43d746cd0ca1b9f0ef4d3737f2

```{r, echo=FALSE}
# TODO: Update query for weighted averages
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=totalTHC, color=invtype)) + geom_line() +
  labs(title="THC Content by Inventory Type",
       y="THC Percent",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")


# Table
retailUSDxType %>%
  select(invtype, date, totalTHC) %>%
  spread(invtype, totalTHC) %>%
  knitr::kable(caption='Mean THC Content By Inventory Type', digits=0)

```

<<<<<<< HEAD
=======
#### CBD Content
>>>>>>> 394a1ae9cfc5ae43d746cd0ca1b9f0ef4d3737f2

```{r, echo=FALSE}
# TODO: Update query for weighted averages
# Chart
retailUSDxType %>%
  ggplot(aes(x=date, y=totalCBD, color=invtype)) + geom_line() +
  labs(title="CBD Content by Inventory Type",
       y="CBD Percent",
       x="") +
  theme_minimal() +
  scale_x_date(date_labels = "%b '%y", date_breaks="6 months")


# Table
retailUSDxType %>%
  select(invtype, date, totalCBD) %>%
  spread(invtype, totalCBD) %>%
  knitr::kable(caption='Mean CBD Content By Inventory Type', digits=0)

```
<<<<<<< HEAD

### Licensee Revenue Analysis

#### Producer/P&P/Processors

This can be generated from inventorytransfers table. inventorytransfer::saleprice. Validate/verify this. (5.3mil records)


```{r}
# GoogleQuery: ?????

# Aggregate revenues for all producers.

```

#### Stores

This can be generated from the dispensing table.
=======
>>>>>>> 394a1ae9cfc5ae43d746cd0ca1b9f0ef4d3737f2
